<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<!--
  Alert Jar - Lightweight PWA-style Web App
  Version: v2.1
  Created: 2025-10-10
  
  Changes (v2.1):
  - Fixed bug preventing liability entries from saving.
  - Microphone now works as a toggle (press to start, press again to stop).
  - Added a light/dark mode theme switcher.
-->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<meta name="description" content="Alert Jar - Personal finance and diary tracker">
<link rel="manifest" href="/manifest.json">
<title>Alert Jar</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --primary: #2563eb;
  --primary-dark: #1e40af;
  --success: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
  --info: #3b82f6;
  --bg: #ffffff;
  --bg-secondary: #f3f4f6;
  --text: #1f2937;
  --text-secondary: #6b7280;
  --border: #e5e7eb;
  --shadow: rgba(0, 0, 0, 0.1);
}

html[data-theme="dark"] {
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --bg: #111827;
  --bg-secondary: #1f2937;
  --text: #f3f4f6;
  --text-secondary: #9ca3af;
  --border: #374151;
  --shadow: rgba(0, 0, 0, 0.2);
}


* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  overflow-x: hidden;
  transition: background-color 0.2s, color 0.2s;
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

header {
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 1px 3px var(--shadow);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

h1 {
  font-size: 1.5rem;
  font-weight: 600;
}

.icon-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 0.375rem;
  color: var(--text-secondary);
}

.icon-btn:hover {
  background: var(--bg-secondary);
}

nav {
  display: flex;
  gap: 0;
  overflow-x: auto;
  border-bottom: 1px solid var(--border);
  scrollbar-width: none;
  -ms-overflow-style: none;
}

nav::-webkit-scrollbar {
  display: none;
}

.tab-btn {
  flex: 1;
  min-width: 80px;
  padding: 0.75rem 1rem;
  border: none;
  background: none;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.tab-btn:hover {
  background: var(--bg-secondary);
}

.tab-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

.tab-btn svg {
  width: 20px;
  height: 20px;
}

main {
  min-height: calc(100vh - 150px);
  padding: 1rem 0;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.sub-tab-nav {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}

.sub-tab-btn {
  padding: 0.5rem 1rem;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 0.875rem;
  color: var(--text-secondary);
  border-bottom: 2px solid transparent;
}

.sub-tab-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
  font-weight: 500;
}

.sub-tab-content {
  display: none;
}

.sub-tab-content.active {
  display: block;
}

.card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  padding: 1.5rem;
  box-shadow: 0 1px 3px var(--shadow);
}

.card h2 {
  font-size: 1.25rem;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.record-btn {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  border: none;
  background: var(--primary);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 1rem auto;
  transition: all 0.2s;
  box-shadow: 0 2px 8px var(--shadow);
}

.record-btn:hover {
  background: var(--primary-dark);
  transform: scale(1.05);
}

.record-btn.recording {
  background: var(--danger);
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.transcription {
  min-height: 60px;
  padding: 0.75rem;
  background: var(--bg-secondary);
  border-radius: 0.375rem;
  margin: 1rem 0;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.transcription.active {
  color: var(--text);
  border: 1px solid var(--primary);
}

.input-group {
  margin: 1rem 0;
}

input[type="text"],
input[type="datetime-local"],
textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-family: inherit;
  background-color: var(--bg);
  color: var(--text);
}

textarea {
  min-height: 80px;
  resize: vertical;
}

.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-secondary {
  background: var(--bg-secondary);
  color: var(--text);
}

.btn-secondary:hover {
  background: var(--border);
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-small {
  padding: 0.375rem 0.75rem;
  font-size: 0.75rem;
}

.totals {
  display: flex;
  gap: 1rem;
  margin: 1rem 0;
  flex-wrap: wrap;
}

.total-card {
  flex: 1;
  min-width: 120px;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: 0.375rem;
  text-align: center;
}

.total-card .label {
  font-size: 0.75rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.total-card .amount {
  font-size: 1.5rem;
  font-weight: 600;
  margin-top: 0.25rem;
}

.total-card.asset .amount {
  color: var(--success);
}

.total-card.liability .amount {
  color: var(--danger);
}

.tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin: 1rem 0;
}

.tag {
  padding: 0.25rem 0.75rem;
  background: var(--bg-secondary);
  border-radius: 1rem;
  font-size: 0.75rem;
  cursor: pointer;
  border: 1px solid var(--border);
  transition: all 0.2s;
}

.tag:hover, .tag.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.entries {
  margin-top: 1rem;
}

.entry {
  padding: 1rem;
  border: 1px solid var(--border);
  border-radius: 0.375rem;
  margin-bottom: 0.75rem;
  background: var(--bg);
}

.entry-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.5rem;
}

.entry-time {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.entry-amount {
  font-size: 1.125rem;
  font-weight: 600;
}

.entry-amount.asset {
  color: var(--success);
}

.entry-amount.liability {
  color: var(--danger);
}

.entry-text {
  margin: 0.5rem 0;
  font-size: 0.875rem;
}

.entry-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.todo-item {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 0.375rem;
  margin-bottom: 0.5rem;
}

.todo-item.completed {
  opacity: 0.6;
}

.todo-item input[type="checkbox"] {
  margin-top: 0.25rem;
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.todo-content {
  flex: 1;
}

.todo-title {
  font-weight: 500;
}

.todo-due {
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-top: 0.25rem;
}

.todo-due.overdue {
  color: var(--danger);
  font-weight: 500;
}

.calendar {
  margin-top: 1rem;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.calendar-nav {
  display: flex;
  gap: 0.5rem;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.5rem;
}

.calendar-day-header {
  text-align: center;
  font-size: 0.75rem;
  font-weight: 600;
  padding: 0.5rem;
  color: var(--text-secondary);
}

.calendar-day {
  aspect-ratio: 1;
  border: 1px solid var(--border);
  border-radius: 0.375rem;
  padding: 0.5rem;
  cursor: pointer;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.calendar-day:hover {
  background: var(--bg-secondary);
}

.calendar-day.today {
  border-color: var(--primary);
  font-weight: 600;
}

.calendar-day.other-month {
  opacity: 0.3;
  cursor: default;
}

.calendar-indicators {
  display: flex;
  gap: 2px;
  margin-top: 0.25rem;
}

.calendar-indicator {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

.calendar-indicator.asset {
  background: var(--success);
}

.calendar-indicator.liability {
  background: var(--danger);
}

.calendar-indicator.diary {
  background: var(--info);
}

.calendar-indicator.todo {
  background: var(--warning);
}

.graph-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.graph-period-selector .btn {
  margin-right: 0.5rem;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: var(--bg);
  border-radius: 0.5rem;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  padding: 1.5rem;
  position: relative;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.25rem;
  color: var(--text-secondary);
}

.toast {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  background: var(--text);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 0.375rem;
  box-shadow: 0 4px 12px var(--shadow);
  z-index: 2000;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  animation: slideIn 0.3s;
}

@keyframes slideIn {
  from {
    transform: translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.toast.success {
  background: var(--success);
}

.toast.error {
  background: var(--danger);
}

.toast button {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 0.25rem;
  cursor: pointer;
  font-size: 0.875rem;
}

.search-bar {
  margin-bottom: 1rem;
}

.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--text-secondary);
}

.empty-state svg {
  width: 64px;
  height: 64px;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.warning-banner {
  background: #fef3c7;
  color: #92400e;
  border: 1px solid #fbbf24;
  padding: 0.75rem;
  border-radius: 0.375rem;
  margin-bottom: 1rem;
  font-size: 0.875rem;
}

html[data-theme="dark"] .warning-banner {
    background: #373021;
    color: #fde68a;
    border-color: #f59e0b;
}

.export-section {
  margin-top: 2rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}

.export-buttons {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.hidden {
  display: none !important;
}

#theme-toggle .moon { display: none; }
#theme-toggle .sun { display: block; }
html[data-theme="dark"] #theme-toggle .moon { display: block; }
html[data-theme="dark"] #theme-toggle .sun { display: none; }

</style>
</head>
<body>

<header>
  <div class="header-content">
    <h1>Alert Jar</h1>
    <div class="header-actions">
        <button id="theme-toggle" class="icon-btn" aria-label="Toggle theme">
            <svg class="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            <svg class="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </button>
        <button id="help-btn" class="icon-btn" aria-label="Help" title="Help (Ctrl+H)">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
        </button>
    </div>
  </div>
  <nav role="navigation">
    <button class="tab-btn active" data-tab="ledger" aria-label="Ledger">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        <span>Ledger</span>
    </button>
    <button class="tab-btn" data-tab="diary" aria-label="Diary">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
      </svg>
      <span>Diary</span>
    </button>
    <button class="tab-btn" data-tab="calendar" aria-label="Calendar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      <span>Calendar</span>
    </button>
    <button class="tab-btn" data-tab="graphs" aria-label="Graphs">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
        <span>Graphs</span>
    </button>
  </nav>
</header>

<main class="container">
  <div id="ledger-tab" class="tab-content active">
    <div class="card">
        <div class="sub-tab-nav" data-parent="ledger">
            <button class="sub-tab-btn active" data-tab="assets">Assets</button>
            <button class="sub-tab-btn" data-tab="liabilities">Liabilities</button>
        </div>
        
        <div id="assets-subtab" class="sub-tab-content active">
             <h2>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="1" x2="12" y2="23"/>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                Assets
              </h2>
              <div id="speech-warning-asset" class="warning-banner hidden">
                Speech recognition uses your browser's voice service which may send audio to external servers.
              </div>
              <button id="record-asset" class="record-btn" aria-label="Record asset">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                  <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
              </button>
              <div id="transcription-asset" class="transcription" role="status" aria-live="polite">
                Tap microphone to record or type below
              </div>
              <div class="input-group">
                <input type="text" id="manual-asset" placeholder="E.g., Client from web dev 69k rupees" aria-label="Manual asset entry">
              </div>
              <button id="add-asset" class="btn btn-primary">Add Asset</button>
              <div class="totals">
                <div class="total-card asset">
                  <div class="label">Today</div>
                  <div class="amount" id="total-assets-today">₹0</div>
                </div>
                <div class="total-card asset">
                  <div class="label">Filtered</div>
                  <div class="amount" id="total-assets-filtered">₹0</div>
                </div>
              </div>
              <div id="tags-asset" class="tags"></div>
              <div id="entries-asset" class="entries"></div>
        </div>

        <div id="liabilities-subtab" class="sub-tab-content">
              <h2>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="8" x2="12" y2="16"/>
                  <line x1="8" y1="12" x2="16" y2="12"/>
                </svg>
                Liabilities
              </h2>
              <div id="speech-warning-liability" class="warning-banner hidden">
                Speech recognition uses your browser's voice service which may send audio to external servers.
              </div>
              <button id="record-liability" class="record-btn" aria-label="Record liability">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                  <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
              </button>
              <div id="transcription-liability" class="transcription" role="status" aria-live="polite">
                Tap microphone to record or type below
              </div>
              <div class="input-group">
                <input type="text" id="manual-liability" placeholder="E.g., Food for friends 700" aria-label="Manual liability entry">
              </div>
              <button id="add-liability" class="btn btn-primary">Add Liability</button>
              <div class="totals">
                <div class="total-card liability">
                  <div class="label">Today</div>
                  <div class="amount" id="total-liabilities-today">₹0</div>
                </div>
                <div class="total-card liability">
                  <div class="label">Filtered</div>
                  <div class="amount" id="total-liabilities-filtered">₹0</div>
                </div>
              </div>
              <div id="tags-liability" class="tags"></div>
              <div id="entries-liability" class="entries"></div>
        </div>
    </div>
  </div>

  <div id="diary-tab" class="tab-content">
      <div class="card">
        <div class="sub-tab-nav" data-parent="diary">
            <button class="sub-tab-btn active" data-tab="journal">Journal</button>
            <button class="sub-tab-btn" data-tab="todo">To-Do</button>
        </div>

        <div id="journal-subtab" class="sub-tab-content active">
            <h2>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
              </svg>
              Journal
            </h2>
            <div id="speech-warning-diary" class="warning-banner hidden">
              Speech recognition uses your browser's voice service which may send audio to external servers.
            </div>
            <button id="record-diary" class="record-btn" aria-label="Record diary entry">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
              </svg>
            </button>
            <div id="transcription-diary" class="transcription" role="status" aria-live="polite">
              Tap microphone to record or type below
            </div>
            <div class="input-group">
              <textarea id="manual-diary" placeholder="Write your diary entry..." aria-label="Manual diary entry"></textarea>
            </div>
            <button id="add-diary" class="btn btn-primary">Save Entry</button>
            <div class="search-bar">
              <input type="text" id="search-diary" placeholder="Search diary..." aria-label="Search diary">
            </div>
            <div id="tags-diary" class="tags"></div>
            <div id="entries-diary" class="entries"></div>
        </div>

        <div id="todo-subtab" class="sub-tab-content">
            <h2>To-Do</h2>
            <div class="input-group">
              <input type="text" id="todo-title" placeholder="Task title" aria-label="Task title">
            </div>
            <div class="input-group">
              <input type="datetime-local" id="todo-due" aria-label="Due date and time">
            </div>
            <button id="add-todo" class="btn btn-primary">Add Task</button>
            <div style="margin-top: 1.5rem;">
              <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem;">Pending</h3>
              <div id="todos-pending"></div>
            </div>
            <div style="margin-top: 1.5rem;">
              <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem;">Completed</h3>
              <div id="todos-completed"></div>
            </div>
            <div style="margin-top: 1.5rem;">
              <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; color: var(--danger);">Missed</h3>
              <div id="todos-missed"></div>
            </div>
        </div>
      </div>
  </div>

  <div id="calendar-tab" class="tab-content">
    <div class="card">
      <div class="calendar-header">
        <h2 id="calendar-month"></h2>
        <div class="calendar-nav">
          <button id="prev-month" class="btn btn-secondary btn-small">‹</button>
          <button id="today-btn" class="btn btn-secondary btn-small">Today</button>
          <button id="next-month" class="btn btn-secondary btn-small">›</button>
        </div>
      </div>
      
      <div class="calendar">
        <div class="calendar-grid" id="calendar-grid"></div>
      </div>
      
      <div class="export-section">
        <h3>Export Data</h3>
        <div class="export-buttons">
          <button id="export-json" class="btn btn-secondary btn-small">Export JSON</button>
          <button id="export-csv" class="btn btn-secondary btn-small">Export CSV</button>
          <label class="btn btn-secondary btn-small" style="cursor: pointer;">
            Import JSON
            <input type="file" id="import-json" accept=".json" style="display: none;">
          </label>
        </div>
      </div>
    </div>
  </div>

  <div id="graphs-tab" class="tab-content">
    <div class="card">
        <h2>Distribution</h2>
        <div class="graph-controls">
            <div class="graph-period-selector">
                <button class="btn btn-secondary btn-small" data-period="daily">Daily</button>
                <button class="btn btn-secondary btn-small active" data-period="monthly">Monthly</button>
                <button class="btn btn-secondary btn-small" data-period="yearly">Yearly</button>
            </div>
            <button id="download-chart" class="btn btn-primary btn-small">Download PNG</button>
        </div>
        <div>
            <canvas id="distribution-chart"></canvas>
        </div>
    </div>
  </div>
</main>

<div id="help-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Help & Privacy</h2>
      <button class="modal-close" aria-label="Close">×</button>
    </div>
    <div>
      <h3>Keyboard Shortcuts</h3>
      <ul style="margin: 1rem 0; line-height: 2;">
        <li><strong>Arrow Left/Right:</strong> Switch between tabs</li>
        <li><strong>Ctrl+H:</strong> Show/hide this help</li>
      </ul>
      
      <h3>Privacy Notice</h3>
      <p style="margin: 1rem 0;">
        <strong>Speech Recognition:</strong> This app uses your browser's built-in speech recognition, which may send audio to external services (like Google or Apple) for processing. The app itself does not collect or send any data to its own servers.
      </p>
      <p style="margin: 1rem 0;">
        <strong>Data Storage:</strong> All your data is stored locally on your device using IndexedDB. Nothing is sent to any server. Use the export feature to backup your data.
      </p>
      
      <h3>Usage Tips</h3>
      <ul style="margin: 1rem 0; line-height: 2;">
        <li>Speak naturally: "Client from web development 69k rupees"</li>
        <li>Tags are extracted automatically from your text</li>
        <li>Tasks checked off are auto-logged to your diary journal</li>
        <li>Click calendar days to view entries for that date</li>
      </ul>
    </div>
  </div>
</div>

<div id="day-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="day-modal-title"></h2>
      <button class="modal-close" aria-label="Close">×</button>
    </div>
    <div id="day-modal-content"></div>
  </div>
</div>

<script>
// Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(err => {
      console.log('Service Worker registration failed:', err);
    });
  });
}

// Configuration
const CONFIG = {
  DEFAULT_CURRENCY: '₹',
  DB_NAME: 'alertjar-db',
  DB_VERSION: 1,
  TAG_MAP: ['food', 'rent', 'salary', 'client', 'web dev', 'transport', 'shopping', 'gift', 'health', 'misc'],
  STOPWORDS: ['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'as', 'is', 'was', 'are', 'were', 'been', 'be', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'may', 'might', 'must', 'can', 'this', 'that', 'these', 'those', 'i', 'you', 'he', 'she', 'it', 'we', 'they', 'my', 'your', 'his', 'her', 'its', 'our', 'their']
};

// Database
let db;

async function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    
    request.onupgradeneeded = (e) => {
      const database = e.target.result;
      if (!database.objectStoreNames.contains('entries')) {
        const store = database.createObjectStore('entries', { keyPath: 'id' });
        store.createIndex('date', 'date', { unique: false });
        store.createIndex('type', 'type', { unique: false });
        store.createIndex('timestamp', 'timestamp', { unique: false });
      }
    };
  });
}

async function saveEntry(entry) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['entries'], 'readwrite');
    const store = transaction.objectStore('entries');
    const request = store.put(entry);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

async function getEntries(filters = {}) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['entries'], 'readonly');
    const store = transaction.objectStore('entries');
    const request = store.getAll();
    
    request.onsuccess = () => {
      let entries = request.result;
      
      if (filters.type) entries = entries.filter(e => e.type === filters.type);
      if (filters.types) entries = entries.filter(e => filters.types.includes(e.type));
      if (filters.date) entries = entries.filter(e => e.date === filters.date);
      if (filters.tags && filters.tags.length > 0) entries = entries.filter(e => e.tags && e.tags.some(tag => filters.tags.includes(tag)));
      if (filters.search) {
        const search = filters.search.toLowerCase();
        entries = entries.filter(e => e.text.toLowerCase().includes(search) || (e.tags && e.tags.some(tag => tag.includes(search))));
      }
      
      resolve(entries.sort((a, b) => b.timestamp - a.timestamp));
    };
    request.onerror = () => reject(request.error);
  });
}

async function deleteEntry(id) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['entries'], 'readwrite');
    const store = transaction.objectStore('entries');
    const request = store.delete(id);
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

async function updateEntry(id, updates) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['entries'], 'readwrite');
    const store = transaction.objectStore('entries');
    const getRequest = store.get(id);
    
    getRequest.onsuccess = () => {
      const entry = getRequest.result;
      Object.assign(entry, updates);
      const updateRequest = store.put(entry);
      updateRequest.onsuccess = () => resolve(entry);
      updateRequest.onerror = () => reject(updateRequest.error);
    };
    getRequest.onerror = () => reject(getRequest.error);
  });
}

// Utility functions
const uuid = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0; return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16); });
const formatCurrency = (amount) => amount == null ? 'No amount' : CONFIG.DEFAULT_CURRENCY + amount.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
const getLocalDate = () => new Date().toISOString().split('T')[0];
const formatDateTime = (timestamp) => new Date(timestamp).toLocaleString('en-IN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

function parseAmount(text) {
  const patterns = [
    /([+-]?\d{1,3}(?:[,\s]\d{3})*(?:\.\d+)?)/g,
    /(\d+(?:\.\d+)?\s*[kK])/g
  ];
  let amounts = [];
  for (const pattern of patterns) {
    for (const match of text.matchAll(pattern)) {
      let valueStr = (match[1] || match[0]).replace(/[,\s₹]|Rs|INR|rupees?|rupee/gi, '');
      let num = parseFloat(valueStr);
      if (valueStr.match(/[kK]$/i)) num *= 1000;
      if (!isNaN(num)) amounts.push(num);
    }
  }
  return amounts.length > 0 ? amounts[amounts.length - 1] : null;
}

function extractTags(text) {
  const lower = text.toLowerCase();
  const words = new Set(lower.split(/\s+/));
  const tags = new Set();
  CONFIG.TAG_MAP.forEach(tag => { if (lower.includes(tag)) tags.add(tag); });
  const fromMatch = lower.match(/(?:from|for)\s+([\w\s]+?)(?:\s+\d|$)/i);
  if (fromMatch && fromMatch[1].trim().length > 2) tags.add(fromMatch[1].trim());
  words.forEach(word => { if (word.length > 3 && !CONFIG.STOPWORDS.includes(word) && !/\d/.test(word)) tags.add(word); });
  return Array.from(tags).slice(0, 5);
}

function showToast(message, type = 'info', actions = []) {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span>${message}</span>`;
  actions.forEach(action => {
    const btn = document.createElement('button');
    btn.textContent = action.label;
    btn.onclick = () => { action.handler(); toast.remove(); };
    toast.appendChild(btn);
  });
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}

// Speech Recognition
let recognition;
let recognitionIsActive = false;
let currentRecognitionType = null;
let isVoice = false;

function initSpeechRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return false;
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-IN';
  
  recognition.onresult = (event) => {
    let transcript = Array.from(event.results).map(r => r[0].transcript).join('');
    const transcriptionEl = document.getElementById(`transcription-${currentRecognitionType}`);
    if (transcriptionEl) {
      transcriptionEl.textContent = transcript;
      transcriptionEl.classList.add('active');
    }
    isVoice = true;
    document.getElementById(`manual-${currentRecognitionType}`).value = transcript;
  };
  
  recognition.onerror = (event) => {
    console.error('Speech recognition error:', event.error);
    showToast(`Speech error: ${event.error}`, 'error');
    stopRecording();
  };
  
  recognition.onend = () => {
    if (recognitionIsActive) {
      try { recognition.start(); } catch (e) { stopRecording(); }
    } else {
      stopRecordingCleanupUI();
    }
  };
  return true;
}

function handleRecordButtonClick(type) {
    if (recognitionIsActive) {
        stopRecording();
    } else {
        startRecording(type);
    }
}

function startRecording(type) {
  if (!recognition) {
    showToast('Speech recognition not available.', 'error');
    return;
  }
  
  currentRecognitionType = type;
  recognitionIsActive = true;
  document.getElementById(`speech-warning-${type}`).classList.remove('hidden');
  document.getElementById(`record-${type}`).classList.add('recording');
  const transcriptionEl = document.getElementById(`transcription-${type}`);
  transcriptionEl.textContent = 'Listening...';
  transcriptionEl.classList.add('active');
  isVoice = false;
  
  try { recognition.start(); } catch (e) {
    stopRecording();
    showToast('Failed to start recording.', 'error');
  }
}

function stopRecording() {
    recognitionIsActive = false;
    if (recognition) {
        try { recognition.stop(); } catch(e) {}
    }
    stopRecordingCleanupUI();
}

function stopRecordingCleanupUI() {
    if (currentRecognitionType) {
        document.getElementById(`record-${currentRecognitionType}`)?.classList.remove('recording');
    }
    // Don't reset currentRecognitionType here, onend needs it
}

// Entry Management
async function addEntry(type, text) {
  if (!text.trim()) {
    showToast('Please enter some text', 'error');
    return;
  }
  const entry = {
    id: uuid(),
    type: type,
    date: getLocalDate(),
    timestamp: Date.now(),
    text: text.trim(),
    amount: parseAmount(text),
    tags: extractTags(text),
    source: isVoice ? 'voice' : 'manual'
  };
  
  try {
    await saveEntry(entry);
    showToast('Entry saved!', 'success', [{
      label: 'Undo',
      handler: async () => { await deleteEntry(entry.id); await refreshAll(); showToast('Entry removed', 'info'); }
    }]);
    
    document.getElementById(`manual-${type}`).value = '';
    const transcriptionEl = document.getElementById(`transcription-${type}`);
    transcriptionEl.textContent = 'Tap microphone to record or type below';
    transcriptionEl.classList.remove('active');
    isVoice = false;
    
    await refreshAll();
  } catch (error) {
    console.error('Failed to save entry:', error, 'Entry object:', entry);
    showToast('Failed to save entry', 'error');
  }
}

async function refreshEntries(type) {
  const today = getLocalDate();
  const allEntries = await getEntries({ type });
  const todayEntries = allEntries.filter(e => e.date === today);
  
  const todayTotal = todayEntries.reduce((sum, e) => sum + (e.amount || 0), 0);
  document.getElementById(`total-${type}s-today`).textContent = formatCurrency(todayTotal);
  
  const allTags = new Set(allEntries.flatMap(e => e.tags || []));
  renderTags(type, Array.from(allTags));
  
  renderEntries(type, allEntries);
}

function renderTags(type, tags) {
  const container = document.getElementById(`tags-${type}`);
  if (!container) return;
  container.innerHTML = tags.map(tag => `<button class="tag" data-tag="${tag}">${tag}</button>`).join('');
  container.querySelectorAll('.tag').forEach(btn => btn.addEventListener('click', () => filterByTag(type, btn.dataset.tag, btn)));
}

async function filterByTag(type, tag, btnEl) {
  const isActive = btnEl.classList.toggle('active');
  document.querySelectorAll(`#tags-${type} .tag`).forEach(b => { if(b !== btnEl) b.classList.remove('active'); });
  
  if (isActive) {
    const entries = await getEntries({ type, tags: [tag] });
    const filteredTotal = entries.reduce((sum, e) => sum + (e.amount || 0), 0);
    document.getElementById(`total-${type}s-filtered`).textContent = formatCurrency(filteredTotal);
    renderEntries(type, entries);
  } else {
    document.getElementById(`total-${type}s-filtered`).textContent = formatCurrency(0);
    await refreshEntries(type);
  }
}

function renderEntries(type, entries) {
  const container = document.getElementById(`entries-${type}`);
  if (!container) return;
  container.innerHTML = entries.length === 0 ? `<div class="empty-state"><p>No entries yet</p></div>` : entries.map(entry => `
    <div class="entry">
      <div class="entry-header">
        <div class="entry-time">${formatDateTime(entry.timestamp)}</div>
        ${entry.amount != null ? `<div class="entry-amount ${type}">${formatCurrency(entry.amount)}</div>` : ''}
      </div>
      <div class="entry-text">${entry.text}</div>
      ${entry.tags && entry.tags.length > 0 ? `<div class="tags">${entry.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
      <div class="entry-actions"><button class="btn btn-danger btn-small" onclick="deleteEntryById('${entry.id}')">Delete</button></div>
    </div>`).join('');
}

async function deleteEntryById(id) {
  if (!confirm('Delete this entry?')) return;
  try {
    await deleteEntry(id);
    showToast('Entry deleted', 'success');
    await refreshAll();
  } catch (error) { showToast('Failed to delete entry', 'error'); }
}

// Diary
async function addDiaryEntry(text) {
  if (!text.trim()) {
    showToast('Please enter some text', 'error');
    return;
  }
  const entry = { id: uuid(), type: 'diary', date: getLocalDate(), timestamp: Date.now(), text: text.trim(), tags: extractTags(text), source: isVoice ? 'voice' : 'manual' };
  try {
    await saveEntry(entry);
    showToast('Diary entry saved!', 'success');
    document.getElementById('manual-diary').value = '';
    const transcriptionEl = document.getElementById('transcription-diary');
    transcriptionEl.textContent = 'Tap microphone to record or type below';
    transcriptionEl.classList.remove('active');
    isVoice = false;
    await refreshDiary();
    await renderCalendar();
  } catch (error) { showToast('Failed to save diary entry', 'error'); }
}

async function refreshDiary() {
  const entries = await getEntries({ type: 'diary', search: document.getElementById('search-diary').value });
  const allTags = new Set(entries.flatMap(e => e.tags || []));
  renderDiaryTags(Array.from(allTags));
  renderDiaryEntries(entries);
}

function renderDiaryTags(tags) {
  const container = document.getElementById('tags-diary');
  if (!container) return;
  container.innerHTML = tags.map(tag => `<button class="tag" data-tag="${tag}">${tag}</button>`).join('');
  container.querySelectorAll('.tag').forEach(btn => btn.addEventListener('click', () => filterDiaryByTag(btn.dataset.tag, btn)));
}

async function filterDiaryByTag(tag, btnEl) {
  const isActive = btnEl.classList.toggle('active');
  document.querySelectorAll('#tags-diary .tag').forEach(b => { if (b !== btnEl) b.classList.remove('active'); });
  renderDiaryEntries(await getEntries({ type: 'diary', tags: isActive ? [tag] : [] }));
}

function renderDiaryEntries(entries) {
  const container = document.getElementById('entries-diary');
  if (!container) return;
  container.innerHTML = entries.length === 0 ? `<div class="empty-state"><p>No diary entries yet</p></div>` : entries.map(entry => `
    <div class="entry">
      <div class="entry-header"><div class="entry-time">${formatDateTime(entry.timestamp)}</div></div>
      <div class="entry-text">${entry.text}</div>
       ${entry.tags && entry.tags.length > 0 ? `<div class="tags">${entry.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
      <div class="entry-actions"><button class="btn btn-danger btn-small" onclick="deleteEntryById('${entry.id}')">Delete</button></div>
    </div>`).join('');
}

// To-Do
async function addTodo() {
  const titleInput = document.getElementById('todo-title');
  const title = titleInput.value.trim();
  if (!title) { showToast('Please enter a task title', 'error'); return; }
  const entry = { id: uuid(), type: 'todo', date: getLocalDate(), timestamp: Date.now(), text: title, todoMeta: { status: 'pending', due: document.getElementById('todo-due').value || null } };
  try {
    await saveEntry(entry);
    showToast('Task added!', 'success');
    titleInput.value = '';
    document.getElementById('todo-due').value = '';
    await refreshTodos();
    await renderCalendar();
  } catch (error) { showToast('Failed to add task', 'error'); }
}

async function toggleTodo(id, checked) {
  try {
    const todo = await getEntries({}).then(all => all.find(e => e.id === id));
    if (!todo) return;
    if (checked) {
      await updateEntry(id, { todoMeta: { ...todo.todoMeta, status: 'done' } });
      await saveEntry({ id: uuid(), type: 'diary', date: getLocalDate(), timestamp: Date.now(), text: `Completed task: ${todo.text}`, tags: ['todo-done', ...extractTags(todo.text)], source: 'todo-auto' });
      showToast('Task completed!', 'success');
    } else {
      await updateEntry(id, { todoMeta: { ...todo.todoMeta, status: 'pending' } });
    }
    await refreshTodos();
    await refreshDiary();
    await renderCalendar();
  } catch (error) { showToast('Failed to update task', 'error'); }
}

async function checkMissedTasks() {
  const now = Date.now();
  const todos = await getEntries({ type: 'todo' });
  let updated = false;
  for (const todo of todos) {
    if (todo.todoMeta.status === 'pending') {
      const dueTime = todo.todoMeta.due ? new Date(todo.todoMeta.due).getTime() : null;
      if (dueTime && dueTime < now) {
        await updateEntry(todo.id, { todoMeta: { ...todo.todoMeta, status: 'missed' } });
        await saveEntry({ id: uuid(), type: 'diary', date: getLocalDate(), timestamp: Date.now(), text: `Missed task: ${todo.text}`, tags: ['todo-missed'], source: 'todo-auto' });
        updated = true;
      }
    }
  }
  if (updated) await refreshAll();
}

async function refreshTodos() {
  const todos = await getEntries({ type: 'todo' });
  renderTodos('pending', todos.filter(e => e.todoMeta.status === 'pending'));
  renderTodos('completed', todos.filter(e => e.todoMeta.status === 'done'));
  renderTodos('missed', todos.filter(e => e.todoMeta.status === 'missed'));
}

function renderTodos(status, todos) {
  const container = document.getElementById(`todos-${status}`);
  if (!container) return;
  if (todos.length === 0) { container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.875rem;">None</p>'; return; }
  container.innerHTML = todos.map(todo => {
    const dueDate = todo.todoMeta.due ? new Date(todo.todoMeta.due) : null;
    const isOverdue = dueDate && dueDate < new Date() && status === 'pending';
    return `
      <div class="todo-item ${status !== 'pending' ? 'completed' : ''}">
        <input type="checkbox" ${status === 'completed' ? 'checked' : ''} onchange="toggleTodo('${todo.id}', this.checked)" ${status === 'missed' ? 'disabled' : ''}>
        <div class="todo-content">
          <div class="todo-title">${todo.text}</div>
          ${dueDate ? `<div class="todo-due ${isOverdue ? 'overdue' : ''}">Due: ${dueDate.toLocaleString('en-IN')}</div>` : ''}
        </div>
        <button class="btn btn-danger btn-small" onclick="deleteEntryById('${todo.id}')">×</button>
      </div>`;
  }).join('');
}

// Calendar
let currentCalendarMonth = new Date();

async function renderCalendar() {
  const year = currentCalendarMonth.getFullYear();
  const month = currentCalendarMonth.getMonth();
  document.getElementById('calendar-month').textContent = currentCalendarMonth.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
  
  const entriesByDate = (await getEntries({})).reduce((acc, e) => {
    acc[e.date] = acc[e.date] || { a: 0, l: 0, d: 0, t: 0 };
    if (e.type === 'asset') acc[e.date].a++;
    else if (e.type === 'liability') acc[e.date].l++;
    else if (e.type === 'diary') acc[e.date].d++;
    else if (e.type === 'todo') acc[e.date].t++;
    return acc;
  }, {});
  
  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `<div class="calendar-day-header">${day}</div>`).join('');
  
  const firstDay = new Date(year, month, 1).getDay();
  for (let i = 0; i < firstDay; i++) grid.insertAdjacentHTML('beforeend', `<div class="calendar-day other-month"></div>`);
  
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  for (let dayNum = 1; dayNum <= daysInMonth; dayNum++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
    const indicatorsData = entriesByDate[dateStr];
    const indicators = indicatorsData ? [
        (indicatorsData.a > 0 ? '<div class="calendar-indicator asset"></div>' : ''),
        (indicatorsData.l > 0 ? '<div class="calendar-indicator liability"></div>' : ''),
        (indicatorsData.d > 0 ? '<div class="calendar-indicator diary"></div>' : ''),
        (indicatorsData.t > 0 ? '<div class="calendar-indicator todo"></div>' : '')
    ].join('') : '';
    
    grid.insertAdjacentHTML('beforeend', `
      <div class="calendar-day ${dateStr === getLocalDate() ? 'today' : ''}" onclick="showDayEntries('${dateStr}')">
        ${dayNum}
        ${indicators ? `<div class="calendar-indicators">${indicators}</div>` : ''}
      </div>`);
  }
}

async function showDayEntries(date) {
    const modal = document.getElementById('day-modal');
    document.getElementById('day-modal-title').textContent = new Date(date + 'T00:00:00').toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const entries = await getEntries({ date });
    const contentEl = document.getElementById('day-modal-content');
    contentEl.innerHTML = entries.length === 0 ? '<p>No entries for this day.</p>' : entries.map(entry => `
        <div class="entry">
          <div class="entry-header">
            <div class="entry-time">${formatDateTime(entry.timestamp)} (${entry.type})</div>
            ${entry.amount != null ? `<div class="entry-amount ${entry.type}">${formatCurrency(entry.amount)}</div>` : ''}
          </div>
          <div class="entry-text">${entry.text}</div>
        </div>`).join('');
    modal.classList.add('active');
}

// Graphs
let chartInstance;
async function renderDistributionGraph() {
    const period = document.querySelector('.graph-period-selector .btn.active')?.dataset.period || 'monthly';
    const entries = await getEntries({ types: ['asset', 'liability'] });
    const data = { assets: {}, liabilities: {} };
    const labels = new Set();
    const now = new Date();

    entries.forEach(entry => {
        if (entry.amount == null) return;
        const date = new Date(entry.timestamp);
        let key;

        if (period === 'daily') {
            const thirtyDaysAgo = new Date().setDate(now.getDate() - 30);
            if (date < thirtyDaysAgo) return;
            key = date.toISOString().split('T')[0];
        } else if (period === 'monthly') {
            key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        } else { // yearly
            key = date.getFullYear().toString();
        }
        labels.add(key);
        data[entry.type][key] = (data[entry.type][key] || 0) + entry.amount;
    });

    const sortedLabels = Array.from(labels).sort();
    const chartData = {
        labels: sortedLabels,
        datasets: [
            { label: 'Assets', data: sortedLabels.map(l => data.assets[l] || 0), backgroundColor: 'rgba(16, 185, 129, 0.7)' },
            { label: 'Liabilities', data: sortedLabels.map(l => data.liabilities[l] || 0), backgroundColor: 'rgba(239, 68, 68, 0.7)' }
        ]
    };
    const chartOptions = {
        scales: { y: { beginAtZero: true, ticks: { color: 'var(--text-secondary)' } }, x: { ticks: { color: 'var(--text-secondary)' } } },
        plugins: { legend: { labels: { color: 'var(--text-secondary)' } } }
    };
    const ctx = document.getElementById('distribution-chart').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, { type: 'bar', data: chartData, options: chartOptions });
}

// Export/Import
const formatCsvField = (data) => {
    if (data == null) return '';
    const string = String(data);
    return (string.includes('"') || string.includes(',') || string.includes('\n')) ? `"${string.replace(/"/g, '""')}"` : string;
}

async function exportData(format) {
  const entries = await getEntries({});
  const date = getLocalDate();
  if (format === 'json') {
    downloadBlob(new Blob([JSON.stringify(entries, null, 2)], { type: 'application/json' }), `alertjar-export-${date}.json`);
  } else if (format === 'csv') {
    const headers = ['id', 'type', 'date', 'timestamp', 'text', 'amount', 'tags', 'source', 'todo_meta'];
    const rows = entries.map(e => [e.id, e.type, e.date, e.timestamp, e.text, e.amount, e.tags ? e.tags.join(';') : '', e.source, e.todoMeta ? JSON.stringify(e.todoMeta) : ''].map(formatCsvField));
    const data = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
    downloadBlob(new Blob([data], { type: 'text/csv;charset=utf-8;' }), `alertjar-export-${date}.csv`);
  }
  showToast(`Exported as ${format.toUpperCase()}`, 'success');
}

function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

document.getElementById('import-json').onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async (event) => {
    try {
      const entries = JSON.parse(event.target.result);
      if (!Array.isArray(entries)) throw new Error("JSON is not an array");
      const transaction = db.transaction(['entries'], 'readwrite');
      const store = transaction.objectStore('entries');
      entries.forEach(entry => store.put(entry));
      transaction.oncomplete = () => { showToast('Import successful', 'success'); refreshAll(); };
      transaction.onerror = () => showToast('Import failed', 'error');
    } catch (error) { showToast('Invalid JSON file', 'error'); }
  };
  reader.readAsText(file);
  e.target.value = '';
};

// Theme Management
function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    if(chartInstance) renderDistributionGraph(); // Re-render chart with new colors
}
function toggleTheme() {
    const currentTheme = localStorage.getItem('theme') || 'light';
    applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
}
(function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
})();


// Event Listeners
const debounce = (func, wait) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func(...a), wait); }; };

document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
    if (btn.dataset.tab === 'graphs') renderDistributionGraph();
}));
document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => {
    const parent = btn.closest('.sub-tab-nav').dataset.parent;
    document.querySelectorAll(`#${parent}-tab .sub-tab-btn, #${parent}-tab .sub-tab-content`).forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(`${btn.dataset.tab}-subtab`).classList.add('active');
}));
document.querySelectorAll('.graph-period-selector .btn').forEach(btn => btn.addEventListener('click', () => {
    document.querySelectorAll('.graph-period-selector .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderDistributionGraph();
}));

// Main actions
document.getElementById('record-asset').onclick = () => handleRecordButtonClick('asset');
document.getElementById('record-liability').onclick = () => handleRecordButtonClick('liability');
document.getElementById('record-diary').onclick = () => handleRecordButtonClick('diary');
document.getElementById('add-asset').onclick = () => addEntry('asset', document.getElementById('manual-asset').value);
document.getElementById('add-liability').onclick = () => addEntry('liability', document.getElementById('manual-liability').value);
document.getElementById('add-diary').onclick = () => addDiaryEntry(document.getElementById('manual-diary').value);
document.getElementById('add-todo').onclick = addTodo;
document.getElementById('search-diary').addEventListener('input', debounce(refreshDiary, 300));
document.getElementById('download-chart').onclick = () => { if (chartInstance) downloadBlob(chartInstance.toBase64Image(), `alertjar-chart-${getLocalDate()}.png`); };

// Modals and toggles
document.getElementById('help-btn').onclick = () => document.getElementById('help-modal').classList.add('active');
document.getElementById('theme-toggle').onclick = toggleTheme;
document.querySelectorAll('.modal-close').forEach(btn => btn.onclick = () => btn.closest('.modal').classList.remove('active'));

// Calendar nav
document.getElementById('prev-month').onclick = () => { currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1); renderCalendar(); };
document.getElementById('next-month').onclick = () => { currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1); renderCalendar(); };
document.getElementById('today-btn').onclick = () => { currentCalendarMonth = new Date(); renderCalendar(); };

// Export buttons
document.getElementById('export-json').onclick = () => exportData('json');
document.getElementById('export-csv').onclick = () => exportData('csv');

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 'h') { e.preventDefault(); document.getElementById('help-modal').classList.toggle('active'); } 
  else if (!e.target.matches('input, textarea')) {
    const tabs = [...document.querySelectorAll('.tab-btn')];
    const currentIndex = tabs.findIndex(tab => tab.classList.contains('active'));
    if (e.key === 'ArrowLeft') tabs[(currentIndex - 1 + tabs.length) % tabs.length].click();
    else if (e.key === 'ArrowRight') tabs[(currentIndex + 1) % tabs.length].click();
  }
});

// Initial Setup
const refreshAll = () => Promise.all([ refreshEntries('asset'), refreshEntries('liability'), refreshDiary(), refreshTodos(), renderCalendar(), document.querySelector('.tab-btn.active[data-tab="graphs"]') && renderDistributionGraph() ]);
initDB().then(() => {
  refreshAll();
  checkMissedTasks();
  setInterval(checkMissedTasks, 5 * 60 * 1000);
}).catch(error => { showToast('Failed to initialize app.', 'error'); });
initSpeechRecognition();

</script>
</body>
</html>
