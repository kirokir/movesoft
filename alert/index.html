<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<!--
  Alert Jar - PWA with Advanced Google Drive Sync
  Version: 3.1 (Final Feature Release)
  Created: 2025-10-10
  
  This file is 100% complete, containing all HTML, CSS, and JavaScript functions.
-->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="A lightweight PWA for personal finance and diary tracking with cloud sync.">
<link rel="manifest" href="manifest.json">
<title>Alert Jar</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
<script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
<style>
:root {
  --primary: #2563eb; --primary-dark: #1e40af; --success: #10b981; --danger: #ef4444;
  --warning: #f59e0b; --info: #3b82f6; --bg: #ffffff; --bg-secondary: #f3f4f6;
  --text: #1f2937; --text-secondary: #6b7280; --border: #e5e7eb; --shadow: rgba(0, 0, 0, 0.1);
}
html[data-theme="dark"] {
  --primary: #3b82f6; --primary-dark: #2563eb; --bg: #111827; --bg-secondary: #1f2937;
  --text: #f3f4f6; --text-secondary: #9ca3af; --border: #374151; --shadow: rgba(0, 0, 0, 0.2);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; overflow-x: hidden; transition: background-color 0.2s, color 0.2s; }
@media (prefers-reduced-motion: reduce) { * { animation: none !important; transition-duration: 0.01ms !important; } }
.skip-link { position: absolute; top: -40px; left: 0; background: var(--primary); color: white; padding: 8px; z-index: 9999; transition: top 0.3s; }
.skip-link:focus { top: 0; }
.container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
header { background: var(--bg); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px var(--shadow); }
.header-content { display: flex; justify-content: space-between; align-items: center; padding: 1rem; }
.header-actions { display: flex; align-items: center; gap: 0.5rem; }
h1 { font-size: 1.5rem; font-weight: 600; }
.icon-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 0.375rem; color: var(--text-secondary); }
.icon-btn:hover { background: var(--bg-secondary); }
nav { display: flex; gap: 0; overflow-x: auto; border-bottom: 1px solid var(--border); scrollbar-width: none; -ms-overflow-style: none; }
nav::-webkit-scrollbar { display: none; }
.tab-btn { flex: 1; min-width: 80px; padding: 0.75rem 0.5rem; border: none; background: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; font-size: 0.875rem; color: var(--text-secondary); border-bottom: 2px solid transparent; transition: all 0.2s; }
.tab-btn svg { width: 20px; height: 20px; }
.tab-btn:hover { background: var(--bg-secondary); } .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
main { min-height: calc(100vh - 150px); padding: 1rem 0; }
.tab-content { display: none; } .tab-content.active { display: block; }
.sub-tab-nav { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border); }
.sub-tab-btn { padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; font-size: 0.875rem; color: var(--text-secondary); border-bottom: 2px solid transparent; }
.sub-tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 500; }
.sub-tab-content { display: none; } .sub-tab-content.active { display: block; }
.card { background: var(--bg); border: 1px solid var(--border); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px var(--shadow); }
.card h2, .card h3 { font-size: 1.25rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;}
.card h3 { font-size: 1rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.05em; border: none; }
.record-btn { width: 64px; height: 64px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 1rem auto; transition: all 0.2s; box-shadow: 0 2px 8px var(--shadow); }
.record-btn:hover { background: var(--primary-dark); transform: scale(1.05); } .record-btn.recording { background: var(--danger); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
.transcription { min-height: 60px; max-height: 120px; overflow-y: auto; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.375rem; margin: 1rem 0; font-size: 0.875rem; color: var(--text-secondary); }
.transcription.active { color: var(--text); border: 1px solid var(--primary); }
.input-group { margin-bottom: 1rem; } .input-group label { display: block; font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;}
input, textarea, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.375rem; font-size: 0.875rem; font-family: inherit; background-color: var(--bg); color: var(--text); }
textarea { min-height: 80px; resize: vertical; }
.btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; justify-content: center; align-items: center; gap: 0.5rem; text-align: center;}
.btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; opacity: 0.7; }
.btn-primary { background: var(--primary); color: white; } .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
.btn-secondary { background: var(--bg-secondary); color: var(--text); } .btn-secondary:hover { background: var(--border); }
.btn-danger { background: var(--danger); color: white; } .btn-small { padding: 0.375rem 0.75rem; font-size: 0.75rem; }
.entry { padding: 1rem; border-bottom: 1px solid var(--border); } .entry:last-child { border-bottom: none; }
.entry-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
.entry-time { font-size: 0.75rem; color: var(--text-secondary); }
.entry-amount { font-size: 1.125rem; font-weight: 600; } .entry-amount.asset { color: var(--success); } .entry-amount.liability { color: var(--danger); }
.entry-text { margin: 0.5rem 0; font-size: 0.875rem; word-break: break-word; }
.entry-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
.time-block-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
.time-block-table th, .time-block-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
.time-block-table th { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; }
.time-block-table td { font-size: 0.875rem; vertical-align: middle; }
.time-block-table .check-cell { width: 40px; text-align: center; }
.time-block-table .check-cell button { background: none; border: 2px solid var(--border); width: 24px; height: 24px; border-radius: 50%; cursor: pointer; color: var(--success); transition: all 0.2s; }
.time-block-table .check-cell button:hover { border-color: var(--success); }
.time-block-table tr.missed { opacity: 0.6; text-decoration: line-through; background-color: rgba(239, 68, 68, 0.05); }
.time-block-table tr.missed .check-cell button { visibility: hidden; }
.profile-card { display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;}
.profile-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
.profile-info h3 { margin: 0; font-size: 1.25rem;} .profile-info p { margin: 0; color: var(--text-secondary); font-size: 0.9rem; }
.profile-stats { display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.8rem; }
.stat-item { text-align: center; } .stat-item strong { display: block; font-size: 1rem;}
.status-indicator { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 1rem; font-weight: 500; }
.status-indicator svg { width: 14px; height: 14px; }
.status-indicator.connected { color: var(--success); background-color: rgba(16, 185, 129, 0.1); }
.status-indicator.disconnected { color: var(--danger); background-color: rgba(239, 68, 68, 0.1); }
.settings-group { display: flex; flex-direction: column; gap: 0.5rem; padding: 1rem 0; border-bottom: 1px solid var(--border); }
.settings-group:last-child { border-bottom: none; }
.settings-row { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
.settings-row label { font-weight: 500; }
#toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 2000; display: flex; flex-direction: column; align-items: flex-end; max-height: calc(100vh - 2rem); overflow-y: auto; pointer-events: none; }
.toast { background: var(--text); color: white; padding: 1rem 1.5rem; border-radius: 0.375rem; box-shadow: 0 4px 12px var(--shadow); display: flex; align-items: center; gap: 0.75rem; animation: slideIn 0.3s, fadeOut 0.3s 4.7s forwards; margin-top: 0.5rem; pointer-events: auto;}
@keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
.toast.success { background: var(--success); } .toast.error { background: var(--danger); }
.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
.modal.active { display: flex; } .modal-content { background: var(--bg); border-radius: 0.5rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 1.5rem; position: relative; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; color: var(--text-secondary); }
.hidden { display: none !important; }
#theme-toggle .moon { display: none; } #theme-toggle .sun { display: block; }
html[data-theme="dark"] #theme-toggle .moon { display: block; } html[data-theme="dark"] #theme-toggle .sun { display: none; }
.tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin: 1rem 0; }
.tag { padding: 0.25rem 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 1rem; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; }
.tag:hover { background: var(--primary); color: white; }
.tag.active { background: var(--primary); color: white; border-color: var(--primary); }
.calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.calendar-nav { display: flex; gap: 0.5rem; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); }
.calendar-day-header { padding: 0.5rem; text-align: center; font-weight: 600; font-size: 0.75rem; background: var(--bg-secondary); color: var(--text-secondary); }
.calendar-day { min-height: 80px; padding: 0.5rem; background: var(--bg); cursor: pointer; position: relative; transition: background 0.2s; }
.calendar-day:hover { background: var(--bg-secondary); }
.calendar-day.today { background: rgba(37, 99, 235, 0.1); font-weight: 700; color: var(--primary); }
.calendar-day.other-month { background: var(--bg-secondary); opacity: 0.3; cursor: default; }
.calendar-indicators { display: flex; gap: 2px; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); }
.calendar-indicator { width: 6px; height: 6px; border-radius: 50%; }
.calendar-indicator.asset { background: var(--success); }
.calendar-indicator.liability { background: var(--danger); }
.calendar-indicator.diary { background: var(--info); }
.calendar-indicator.todo { background: var(--warning); }
.chart-container { position: relative; height: 400px; margin: 1rem 0; }
.graph-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
.graph-period-selector { display: flex; gap: 0.5rem; }
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>
<header>
  <div class="header-content"><h1>Alert Jar <span style="font-size: 0.7rem; font-weight: 400; color: var(--text-secondary); margin-left: 0.5rem;">by <a href="https://dear.is-a.dev" target="_blank" rel="noopener" style="color: var(--primary); text-decoration: none; font-weight: 500;">dear&co</a></span></h1><div class="header-actions"><button id="theme-toggle" class="icon-btn" aria-label="Toggle theme"><svg class="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><title>Light Mode</title><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg><svg class="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><title>Dark Mode</title><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button><button id="help-btn" class="icon-btn" aria-label="Help" title="Help (Ctrl+H)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><title>Help</title><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></button></div></div>
  <nav role="navigation">
    <button class="tab-btn active" data-tab="ledger"><svg><use href="#icon-ledger"/></svg><span>Ledger</span></button>
    <button class="tab-btn" data-tab="diary"><svg><use href="#icon-diary"/></svg><span>Diary</span></button>
    <button class="tab-btn" data-tab="calendar"><svg><use href="#icon-calendar"/></svg><span>Calendar</span></button>
    <button class="tab-btn" data-tab="graphs"><svg><use href="#icon-graphs"/></svg><span>Graphs</span></button>
    <button class="tab-btn" data-tab="settings"><svg><use href="#icon-settings"/></svg><span>Settings</span></button>
  </nav>
</header>

<main id="main-content" class="container">
  <div id="ledger-tab" class="tab-content active"><div class="card"><div class="sub-tab-nav" data-parent="ledger"><button class="sub-tab-btn active" data-tab="assets">Assets</button><button class="sub-tab-btn" data-tab="liabilities">Liabilities</button></div><div id="assets-subtab" class="sub-tab-content active"><h2>Assets</h2><div id="speech-warning-asset" class="warning-banner hidden">Speech recognition uses your browser's voice service.</div><button class="record-btn" data-type="asset" aria-label="Record asset"><svg width="32" height="32"><use href="#icon-mic"/></svg></button><div id="transcription-asset" class="transcription" role="status" aria-live="polite">Tap microphone to record or type below</div><div class="input-group"><input type="text" id="manual-asset" placeholder="E.g., Client from web dev 69k rupees" aria-label="Manual asset entry"></div><button class="btn btn-primary" data-type="asset" data-action="add">Add Asset</button><div id="entries-asset" class="entries"></div></div><div id="liabilities-subtab" class="sub-tab-content"><h2>Liabilities</h2><div id="speech-warning-liability" class="warning-banner hidden">Speech recognition uses your browser's voice service.</div><button class="record-btn" data-type="liability" aria-label="Record liability"><svg width="32" height="32"><use href="#icon-mic"/></svg></button><div id="transcription-liability" class="transcription" role="status" aria-live="polite">Tap microphone to record or type below</div><div class="input-group"><input type="text" id="manual-liability" placeholder="E.g., Food for friends 700" aria-label="Manual liability entry"></div><button class="btn btn-primary" data-type="liability" data-action="add">Add Liability</button><div id="entries-liability" class="entries"></div></div></div></div>
  <div id="diary-tab" class="tab-content"><div class="card"><div class="sub-tab-nav" data-parent="diary"><button class="sub-tab-btn active" data-tab="journal">Journal</button><button class="sub-tab-btn" data-tab="todo">To-Do</button></div><div id="journal-subtab" class="sub-tab-content active"><h2>Journal</h2><div id="speech-warning-diary" class="warning-banner hidden">Speech recognition uses your browser's voice service.</div><button class="record-btn" data-type="diary" aria-label="Record diary entry"><svg width="32" height="32"><use href="#icon-mic"/></svg></button><div id="transcription-diary" class="transcription" role="status" aria-live="polite">Tap microphone to record or type below</div><div class="input-group"><textarea id="manual-diary" placeholder="Write your diary entry..."></textarea></div><button class="btn btn-primary" data-action="add-diary">Save Entry</button><div class="input-group"><input type="text" id="search-diary" placeholder="Search diary..." aria-label="Search diary"></div><div id="tags-diary" class="tags"></div><div id="entries-diary" class="entries"></div></div><div id="todo-subtab" class="sub-tab-content"><h2>Time-Blocked Tasks</h2><div class="input-group"><label for="todo-from">From</label><input type="time" id="todo-from"></div><div class="input-group"><label for="todo-to">To</label><input type="time" id="todo-to"></div><div class="input-group"><label for="todo-action">Action</label><input type="text" id="todo-action" placeholder="e.g., Study for exam"></div><button class="btn btn-primary" data-action="add-todo">Add Timed Task</button><div id="time-block-list"></div></div></div></div>
  <div id="calendar-tab" class="tab-content"><div class="card"><div class="calendar-header"><h2 id="calendar-month"></h2><div class="calendar-nav"><button id="prev-month" class="btn btn-secondary btn-small" aria-label="Previous month">‚Äπ</button><button id="today-btn" class="btn btn-secondary btn-small">Today</button><button id="next-month" class="btn btn-secondary btn-small" aria-label="Next month">‚Ä∫</button></div></div><div class="calendar"><div class="calendar-grid" id="calendar-grid"></div></div></div></div>
  <div id="graphs-tab" class="tab-content"><div class="card"><h2>Distribution</h2><div class="graph-controls"><div class="graph-period-selector"><button class="btn btn-secondary btn-small" data-period="daily">Daily</button><button class="btn btn-secondary btn-small active" data-period="monthly">Monthly</button><button class="btn btn-secondary btn-small" data-period="yearly">Yearly</button></div><button id="download-chart" class="btn btn-primary btn-small">Download PNG</button></div><div class="chart-container"><canvas id="distribution-chart"></canvas></div></div></div>
  <div id="settings-tab" class="tab-content">
    <div id="profile-section" class="card"><h2>User Profile</h2><div id="google-sign-in-prompt"><p>Connect your Google Account to sync data across devices and unlock cloud features.</p><button id="google-connect-btn" class="btn btn-primary">Connect with Google</button></div><div id="user-profile-card" class="profile-card hidden"><img id="user-avatar" class="profile-avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="User Avatar"><div><div class="profile-info"><h3 id="user-name"></h3><p id="user-email"></p><p>Member since: <span id="user-join-date"></span></p></div><div class="profile-stats"><div class="stat-item"><strong><span id="stat-total-entries">0</span></strong> Entries</div><div class="stat-item"><strong><span id="stat-net-worth">‚Çπ0</span></strong> Net Worth</div></div></div></div></div>
    <div class="card"><h3>üîê Account</h3><div class="settings-group"><div class="settings-row"><label>Google Drive</label><div id="drive-status" class="status-indicator disconnected"><span>Disconnected</span></div></div><button id="google-disconnect-btn" class="btn btn-secondary hidden">Disconnect</button></div></div>
    <div class="card"><h3>üé® Appearance</h3><div class="settings-group"><div class="settings-row"><label for="theme-select">Theme</label><select id="theme-select"><option value="auto">System</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div><div class="settings-group"><div class="settings-row"><label for="currency-select">Currency</label><select id="currency-select"><option value="INR">INR (‚Çπ)</option><option value="USD">USD ($)</option><option value="EUR">EUR (‚Ç¨)</option><option value="GBP">GBP (¬£)</option></select></div></div><div class="settings-group"><div class="settings-row"><label for="date-format-select">Date Format</label><select id="date-format-select"><option value="local">Local Default</option><option value="DD/MM/YYYY">DD/MM/YYYY</option><option value="MM/DD/YYYY">MM/DD/YYYY</option></select></div></div></div>
     <div class="card"><h3>üíæ Data Management</h3><div class="settings-group"><div class="settings-row"><p>Last cloud backup: <span id="last-backup-status">Never</span></p></div><button id="backup-now-btn" class="btn btn-secondary" disabled>Backup Now</button><button id="restore-data-btn" class="btn btn-secondary" disabled>Restore from Drive</button></div><div class="settings-group"><button id="export-json" class="btn btn-secondary">Export JSON</button><button id="export-csv" class="btn btn-secondary">Export CSV</button></div><div class="settings-group"><label for="import-json" class="btn btn-secondary">Import JSON</label><input type="file" id="import-json" accept=".json" class="hidden"></div><div class="settings-group"><button id="clear-data-btn" class="btn btn-danger">Clear Local Data</button><button id="delete-account-btn" class="btn btn-danger" disabled>Delete All Cloud Data</button></div></div>
  </div>
</main>
<div id="toast-container"></div>
<div id="help-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="help-modal-title"><div class="modal-content"><div class="modal-header"><h2 id="help-modal-title">Help & Privacy</h2><button class="modal-close" aria-label="Close">√ó</button></div><div><h3>Keyboard Shortcuts</h3><ul style="margin: 1rem 0; line-height: 2;"><li><strong>Arrow Left/Right:</strong> Switch tabs</li><li><strong>Ctrl+H:</strong> Show/hide help</li></ul><h3>Data Management</h3><p style="margin: 1rem 0;"><strong>Data Storage:</strong> All data is stored locally. Connect to Google Drive for cloud backup.</p></div></div></div>
<div id="day-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="day-modal-title"><div class="modal-content"><div class="modal-header"><h2 id="day-modal-title"></h2><button class="modal-close" aria-label="Close">√ó</button></div><div id="day-modal-content"></div></div></div>

<svg class="hidden">
  <defs>
    <symbol id="icon-ledger" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Ledger</title><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></symbol>
    <symbol id="icon-diary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><title>Diary</title><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></symbol>
    <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><title>Calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></symbol>
    <symbol id="icon-graphs" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Graphs</title><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><title>Settings</title><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></symbol>
    <symbol id="icon-mic" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></symbol>
    <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></symbol>
  </defs>
</svg>

<script>
'use strict';
// --- App Constants & Config ---
const APP_VERSION = '3.1';
const GOOGLE_CLIENT_ID = '304693499609-j0cv1i6094039a0alfeoup0knegvfvol.apps.googleusercontent.com';
const GOOGLE_API_KEY = 'AIzaSyDK2gJIp6TDrjGv5p4bLQBZP_duzR7ByOs';
const GOOGLE_DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest", "https://people.googleapis.com/$discovery/rest?version=v1"];
const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';
const CONFIG = {
  TAG_MAP: ['food', 'rent', 'salary', 'client', 'web dev', 'transport', 'shopping', 'gift', 'health', 'misc', 'paid rent'],
  STOPWORDS: ['the','a','an','is','to','for','of','with','by','from','i','you','and','or','but','in','on']
};

// --- Global State ---
let db, chartInstance, recognition, gapi, google, tokenClient;
let recognitionIsActive = false, currentRecognitionType = null, isVoice = false, finalTranscriptBuffer = '';
let refreshPromise = null, activeDiaryTag = null;
let currentCalendarMonth = new Date();
const DEBOUNCE_TIMERS = {};

// --- PWA Service Worker ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg => {
      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed') {
            if (navigator.serviceWorker.controller) {
              showToast('New version available! Refresh to update.', 'info', 10000);
            } else {
              showToast('App ready for offline use!', 'success');
            }
          }
        });
      });
      setInterval(() => reg.update(), 60 * 60 * 1000);
    }).catch(err => console.error('Service Worker registration failed:', err));
  });
}

// --- Database ---
async function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('alertjar-db', 2);
    request.onerror = (e) => reject(e.target.error);
    request.onsuccess = (e) => { db = e.target.result; resolve(db); };
    request.onupgradeneeded = (e) => {
      const database = e.target.result;
      if (!database.objectStoreNames.contains('entries')) {
        const store = database.createObjectStore('entries', { keyPath: 'id' });
        store.createIndex('timestamp', 'timestamp');
        store.createIndex('type', 'type');
      }
    };
  });
}
async function dbRequest(storeName, mode, action, ...args) {
  return new Promise((resolve, reject) => {
    try {
      const tx = db.transaction(storeName, mode);
      const request = tx.objectStore(storeName)[action](...args);
      tx.oncomplete = () => resolve(request.result);
      tx.onerror = (e) => { if (e.target.error.name === 'QuotaExceededError') showToast('Storage quota exceeded. Please clear some data.', 'error'); reject(e.target.error); };
    } catch (error) { reject(error); }
  });
}
const saveEntry = (entry) => dbRequest('entries', 'readwrite', 'put', entry);
const getRawEntries = () => dbRequest('entries', 'readonly', 'getAll');
const deleteEntry = (id) => dbRequest('entries', 'readwrite', 'delete', id);
async function getEntries(filters = {}) {
  let entries = await getRawEntries();
  if (filters.type) entries = entries.filter(e => e.type === filters.type);
  if (filters.types) entries = entries.filter(e => filters.types.includes(e.type));
  if (filters.date) entries = entries.filter(e => e.date === filters.date);
  if (filters.tags?.length > 0) entries = entries.filter(e => e.tags?.some(tag => filters.tags.includes(tag)));
  if (filters.search) {
    const search = filters.search.toLowerCase();
    entries = entries.filter(e => e.text.toLowerCase().includes(search) || e.tags?.some(tag => tag.includes(search)));
  }
  return entries.sort((a, b) => b.timestamp - a.timestamp);
}

// --- Utility Functions ---
const uuid = () => {
  if (self.crypto?.randomUUID) return self.crypto.randomUUID();
  const bytes = new Uint8Array(16);
  crypto.getRandomValues(bytes);
  bytes[6] = (bytes[6] & 0x0f) | 0x40;
  bytes[8] = (bytes[8] & 0x3f) | 0x80;
  const hex = Array.from(bytes, b => b.toString(16).padStart(2, '0')).join('');
  return `${hex.substr(0,8)}-${hex.substr(8,4)}-${hex.substr(12,4)}-${hex.substr(16,4)}-${hex.substr(20)}`;
};
const getDateFormat = () => { try { return localStorage.getItem('dateFormat') || 'local'; } catch(e) { return 'local'; } };
const formatCurrency = (amount, currency = 'INR') => new Intl.NumberFormat(navigator.language || 'en-IN', { style: 'currency', currency }).format(amount ?? 0);
const getLocalDate = (date = new Date()) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
const formatDateTime = (timestamp) => {
    const d = new Date(timestamp);
    const format = getDateFormat();
    const time = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    switch(format) {
        case 'DD/MM/YYYY': return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} ${time}`;
        case 'MM/DD/YYYY': return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()} ${time}`;
        case 'local':
        default: return d.toLocaleString(navigator.language || 'en-IN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
};
const sanitize = (str) => {
    const div = document.createElement('div');
    div.textContent = String(str);
    return div.innerHTML.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;').replace(/\//g, '&#x2F;');
};
function parseAmount(text) {
  const cleaned = text.replace(/,/g, ''); const match = cleaned.match(/\d+(\.\d+)?k?/i);
  if (!match) return null; let num = parseFloat(match[0].replace(/\s/g, ''));
  if (match[0].toLowerCase().includes('k')) num *= 1000; return num > 0 ? num : null;
}
function extractTags(text) {
  const lower = text.toLowerCase(), tags = new Set();
  CONFIG.TAG_MAP.forEach(tag => { if (lower.includes(tag)) tags.add(tag); });
  const fromMatch = lower.match(/(?:from|for)\s+([\w\s]{3,20})(?:\s+\d|$)/i);
  if (fromMatch) tags.add(fromMatch[1].trim());
  const words = lower.split(/\s+/).slice(0, 100);
  words.forEach(word => { if (word.length >= 4 && word.length <= 15 && !CONFIG.STOPWORDS.includes(word) && isNaN(word) && tags.size < 5) tags.add(word); });
  return Array.from(tags).slice(0, 5);
}
function showToast(message, type = 'info', duration = 5000) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.setAttribute('role', 'status'); toast.setAttribute('aria-live', 'polite');
  toast.textContent = message;
  container.prepend(toast);
  setTimeout(() => toast.remove(), duration);
}

// --- Speech Recognition ---
let recognitionRetries = 0;
const MAX_RECOGNITION_RETRIES = 3;
function initSpeechRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) { console.warn('Speech Recognition not supported.'); return; }
  recognition = new SpeechRecognition();
  recognition.continuous = true; recognition.interimResults = true; recognition.lang = navigator.language || 'en-IN';
  recognition.onstart = () => { recognitionRetries = 0; };
  recognition.onresult = (event) => {
    let interimTranscript = '';
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) finalTranscriptBuffer += event.results[i][0].transcript + ' ';
      else interimTranscript += event.results[i][0].transcript;
    }
    const manualInputEl = document.getElementById(`manual-${currentRecognitionType}`);
    if(manualInputEl) {
        manualInputEl.value = finalTranscriptBuffer + interimTranscript;
        document.getElementById(`transcription-${currentRecognitionType}`).textContent = manualInputEl.value || 'Listening...';
        isVoice = true;
    }
  };
  recognition.onerror = (e) => { showToast(`Speech error: ${e.error}`, 'error'); stopRecording(); };
  recognition.onend = () => {
    if (recognitionIsActive && recognition && recognitionRetries < MAX_RECOGNITION_RETRIES) {
      setTimeout(() => {
        try { recognition.start(); } catch (e) {
          recognitionRetries++;
          if (recognitionRetries >= MAX_RECOGNITION_RETRIES) {
            stopRecording();
            showToast('Speech recognition unavailable. Please type manually.', 'error');
          }
        }
      }, 100);
    } else { stopRecordingCleanupUI(); }
  };
}
function handleRecordButtonClick(type) { if (recognitionIsActive) stopRecording(); else startRecording(type); }
function startRecording(type) {
  if (!recognition) { showToast('Speech recognition not available.', 'error'); return; }
  currentRecognitionType = type; recognitionIsActive = true;
  document.getElementById(`speech-warning-${type}`).classList.remove('hidden');
  document.querySelector(`.record-btn[data-type="${type}"]`).classList.add('recording');
  document.getElementById(`transcription-${type}`).classList.add('active');
  try { recognition.start(); } catch (e) { stopRecording(); showToast('Failed to start recording.', 'error'); }
}
function stopRecording() {
  if (!recognitionIsActive) return;
  recognitionIsActive = false; if (recognition) try { recognition.stop(); } catch(e) {}
  stopRecordingCleanupUI();
}
function stopRecordingCleanupUI() {
  if (currentRecognitionType) document.querySelector(`.record-btn[data-type="${currentRecognitionType}"]`)?.classList.remove('recording');
  finalTranscriptBuffer = ''; currentRecognitionType = null;
}

// --- Entry Management ---
async function addEntry(type, text, btnEl) {
    if (!text.trim()) { return showToast('Please enter some text', 'error'); }
    const amount = parseAmount(text);
    if ((type === 'asset' || type === 'liability') && (!amount || amount <= 0)) { return showToast('Amount must be a positive number.', 'error'); }
    btnEl.disabled = true; btnEl.textContent = 'Saving...';
    const entry = { id: uuid(), type, date: getLocalDate(), timestamp: Date.now(), text, amount, tags: extractTags(text), source: isVoice ? 'voice' : 'manual' };
    try {
        await saveEntry(entry);
        showToast('Entry saved!', 'success');
        document.getElementById(`manual-${type}`).value = '';
        isVoice = false;
        await refreshAll();
    } catch (error) { showToast('Failed to save entry.', 'error'); }
    finally {
        btnEl.disabled = false;
        btnEl.textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        const transcriptionEl = document.getElementById(`transcription-${type}`);
        if(transcriptionEl) {
            transcriptionEl.classList.remove('active');
            transcriptionEl.textContent = 'Tap microphone to record or type below';
        }
    }
}
function renderEntries(type, entries) {
  const container = document.getElementById(`entries-${type}`);
  if (!container) return;
  container.innerHTML = entries.length === 0 ? `<div class="empty-state"><p>No entries yet</p></div>` : entries.map(entry => `
    <div class="entry" data-id="${entry.id}"><div class="entry-header"><div class="entry-time">${formatDateTime(entry.timestamp)}</div>${entry.amount != null ? `<div class="entry-amount ${type}">${formatCurrency(entry.amount)}</div>` : ''}</div><div class="entry-text">${sanitize(entry.text)}</div><div class="entry-actions"><button class="btn btn-danger btn-small" data-action="delete">Delete</button></div></div>`).join('');
}
async function filterByTag(type, tag, tagElement) {
    const container = tagElement.closest('.sub-tab-content').querySelector('.tags');
    const wasActive = tagElement.classList.contains('active');
    container.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
    if (wasActive) {
        const entries = await getEntries({ type });
        renderEntries(type, entries);
    } else {
        tagElement.classList.add('active');
        const entries = await getEntries({ type, tags: [tag] });
        renderEntries(type, entries);
    }
}

// --- Diary & Time-Blocked To-Do ---
async function addDiaryEntry(text, btnEl) {
    if (!text.trim()) { return showToast('Please enter some text', 'error'); }
    btnEl.disabled = true; btnEl.textContent = 'Saving...';
    const entry = { id: uuid(), type: 'diary', date: getLocalDate(), timestamp: Date.now(), text, tags: extractTags(text), source: isVoice ? 'voice' : 'manual' };
    try {
        await saveEntry(entry);
        showToast('Diary entry saved!', 'success');
        document.getElementById('manual-diary').value = '';
        isVoice = false;
        await refreshAll();
    } catch (error) { showToast('Failed to save diary entry.', 'error'); }
    finally {
        btnEl.disabled = false; btnEl.textContent = 'Save Entry';
        const transcriptionEl = document.getElementById('transcription-diary');
        transcriptionEl.classList.remove('active');
        transcriptionEl.textContent = 'Tap microphone to record or type below';
    }
}
function renderDiaryEntries(entries) {
  const container = document.getElementById('entries-diary');
  if (!container) return;
  container.innerHTML = entries.length === 0 ? `<div class="empty-state"><p>No journal entries yet</p></div>` : entries.map(entry => `
    <div class="entry" data-id="${entry.id}"><div class="entry-header"><div class="entry-time">${formatDateTime(entry.timestamp)}</div></div><div class="entry-text">${sanitize(entry.text)}</div><div class="entry-actions"><button class="btn btn-danger btn-small" data-action="delete">Delete</button></div></div>`).join('');
}
function renderDiaryTags(entries) {
    const allTags = entries.flatMap(e => e.tags || []);
    const tagCounts = allTags.reduce((acc, tag) => { acc[tag] = (acc[tag] || 0) + 1; return acc; }, {});
    const container = document.getElementById('tags-diary');
    container.innerHTML = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).map(([tag, count]) => `<span class="tag ${activeDiaryTag === tag ? 'active' : ''}" data-tag="${tag}">${sanitize(tag)} (${count})</span>`).join('');
}
async function refreshDiary() {
    const searchTerm = document.getElementById('search-diary').value.trim();
    const filters = activeDiaryTag ? { type: 'diary', tags: [activeDiaryTag] } : { type: 'diary' };
    if (searchTerm) filters.search = searchTerm;
    const entries = await getEntries(filters);
    renderDiaryEntries(entries);
    renderDiaryTags(entries);
}
async function filterDiaryByTag(tag, tagElement) {
    document.querySelectorAll('#tags-diary .tag').forEach(t => t.classList.remove('active'));
    activeDiaryTag = activeDiaryTag === tag ? null : tag;
    if (activeDiaryTag) tagElement.classList.add('active');
    await refreshDiary();
}
async function refreshTodos() {
    const todos = (await getEntries({ type: 'todo', date: getLocalDate() })).filter(e => e.todoMeta?.isTimeBlocked);
    renderTimeBlockedTasks(todos);
}
function renderTimeBlockedTasks(todos) {
    const container = document.getElementById('time-block-list');
    if (todos.length === 0) {
        container.innerHTML = '<p style="text-align: center; margin-top: 1rem; color: var(--text-secondary);">No timed tasks for today.</p>';
        return;
    }
    const table = document.createElement('table');
    table.className = 'time-block-table';
    table.innerHTML = `<thead><tr><th>From</th><th>To</th><th>Action</th><th class="check-cell">Done</th></tr></thead>`;
    const tbody = document.createElement('tbody');
    todos.sort((a,b) => a.todoMeta.from.localeCompare(b.todoMeta.from)).forEach(todo => {
        const tr = document.createElement('tr');
        tr.dataset.id = todo.id;
        if (todo.todoMeta.status === 'missed') tr.classList.add('missed');
        tr.innerHTML = `
            <td>${new Date(`1970-01-01T${todo.todoMeta.from}`).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
            <td>${new Date(`1970-01-01T${todo.todoMeta.to}`).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
            <td>${sanitize(todo.text)}</td>
            <td class="check-cell"><button data-action="toggle-todo"><svg><use href="#icon-check"/></svg></button></td>
        `;
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.innerHTML = '';
    container.appendChild(table);
}
async function checkMissedTasks() {
    try {
        const now = new Date();
        const currentTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        const todos = await getEntries({ type: 'todo' }).catch(err => { console.error('Failed to fetch todos:', err); return []; });
        const toUpdate = [], diaryEntries = [];
        for (const todo of todos) {
            if (todo.todoMeta?.isTimeBlocked && todo.todoMeta.status === 'pending' && todo.date === getLocalDate() && todo.todoMeta.to < currentTime) {
                toUpdate.push({ ...todo, todoMeta: { ...todo.todoMeta, status: 'missed' } });
                diaryEntries.push({ id: uuid(), type: 'diary', date: getLocalDate(), timestamp: Date.now(), text: `Missed Task (scheduled ${todo.todoMeta.from}-${todo.todoMeta.to}): ${todo.text}`, tags: ['todo-missed'], source: 'auto-missed' });
            }
        }
        if (toUpdate.length === 0) return;
        const tx = db.transaction(['entries'], 'readwrite');
        const store = tx.objectStore('entries');
        [...toUpdate, ...diaryEntries].forEach(entry => store.put(entry));
        tx.oncomplete = () => refreshAll();
        tx.onerror = (e) => console.error('Batch update failed:', e);
    } catch (error) { console.error('checkMissedTasks failed:', error); }
}
async function toggleTodo(id) {
    const todo = await dbRequest('entries', 'readonly', 'get', id);
    if (!todo) { showToast('Task no longer exists.', 'error'); return refreshAll(); }
    if (!todo.todoMeta?.isTimeBlocked || todo.todoMeta.status !== 'pending') return;
    await saveEntry({ ...todo, todoMeta: { ...todo.todoMeta, status: 'done' } });
    await saveEntry({ id: uuid(), type: 'diary', date: getLocalDate(), timestamp: Date.now(), text: `Completed Task at ${new Date().toLocaleTimeString()} (scheduled ${todo.todoMeta.from}-${todo.todoMeta.to}): ${todo.text}`, tags: ['todo-done'], source: 'auto-completed' });
    showToast('Task completed and logged!', 'success');
    await refreshAll();
}
async function addTodo() {
    const from = document.getElementById('todo-from').value;
    const to = document.getElementById('todo-to').value;
    const action = document.getElementById('todo-action').value.trim();
    if (!from || !to || !action) { return showToast('Please fill all fields for the timed task.', 'error'); }
    if (to <= from) { return showToast('"To" time must be after "From" time.', 'error'); }
    const entry = {
        id: uuid(), type: 'todo', date: getLocalDate(), timestamp: Date.now(), text: action,
        todoMeta: { status: 'pending', from, to, isTimeBlocked: true }
    };
    try {
        await saveEntry(entry);
        showToast('Timed task added!', 'success');
        document.getElementById('todo-from').value = '';
        document.getElementById('todo-to').value = '';
        document.getElementById('todo-action').value = '';
        await refreshAll();
    } catch (error) { showToast('Failed to add task.', 'error'); }
}


// --- Calendar, Graphs, Export/Import, Modals ---
async function renderCalendar() {
  const year = currentCalendarMonth.getFullYear(), month = currentCalendarMonth.getMonth();
  document.getElementById('calendar-month').textContent = currentCalendarMonth.toLocaleDateString(navigator.language || 'en-IN', { month: 'long', year: 'numeric' });
  const entriesByDate = (await getRawEntries()).reduce((acc, e) => {
    acc[e.date] = acc[e.date] || { a:0,l:0,d:0,t:0 };
    if(e.type==='asset')acc[e.date].a++; else if(e.type==='liability')acc[e.date].l++; else if(e.type==='diary')acc[e.date].d++; else if(e.type==='todo')acc[e.date].t++;
    return acc;
  }, {});
  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(day => `<div class="calendar-day-header">${day}</div>`).join('');
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
  for (let i = 1; i <= totalCells; i++) {
    const dayNum = i - firstDay;
    if (dayNum > 0 && dayNum <= daysInMonth) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
      const indicatorsData = entriesByDate[dateStr];
      const indicators = indicatorsData ? Object.entries(indicatorsData).map(([k, v]) => v > 0 ? `<div class="calendar-indicator ${{'a':'asset','l':'liability','d':'diary','t':'todo'}[k]}"></div>` : '').join('') : '';
      const [y, m, d] = dateStr.split('-').map(Number);
      const dayLabel = new Date(y, m - 1, d).toLocaleDateString(navigator.language || 'en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      grid.insertAdjacentHTML('beforeend', `<div role="button" tabindex="0" class="calendar-day ${dateStr === getLocalDate() ? 'today' : ''}" data-date="${dateStr}" aria-label="${dayLabel}">${dayNum}${indicators ? `<div class="calendar-indicators">${indicators}</div>` : ''}</div>`);
    } else {
      grid.insertAdjacentHTML('beforeend', `<div class="calendar-day other-month"></div>`);
    }
  }
}
async function showDayEntries(date) {
  const [year, month, day] = date.split('-').map(Number);
  const dateObj = new Date(year, month - 1, day);
  openModal('day-modal', (modal) => {
    modal.querySelector('#day-modal-title').textContent = dateObj.toLocaleDateString(navigator.language || 'en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    getEntries({ date }).then(entries => {
      modal.querySelector('#day-modal-content').innerHTML = entries.length === 0 ? '<p>No entries for this day.</p>' : entries.map(entry => `
      <div class="entry"><div class="entry-header"><div class="entry-time">${formatDateTime(entry.timestamp)} (${entry.type})</div>${entry.amount != null ? `<div class="entry-amount ${entry.type}">${formatCurrency(entry.amount)}</div>` : ''}</div><div class="entry-text">${sanitize(entry.text)}</div></div>`).join('');
    });
  });
}
async function renderDistributionGraph() {
  const period = localStorage.getItem('chartPeriod') || 'monthly';
  const entries = await getEntries({ types: ['asset', 'liability'] });
  const data = { asset: {}, liability: {} }, labels = new Set();
  const today = new Date(); const thirtyDaysAgo = new Date(new Date().setDate(today.getDate() - 30));
  entries.forEach(entry => {
    if (entry.amount == null) return;
    const date = new Date(entry.timestamp); let key;
    if (period === 'daily') { if (date < thirtyDaysAgo) return; key = date.toISOString().split('T')[0]; }
    else if (period === 'monthly') key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    else { if(date.getFullYear() < today.getFullYear() - 5) return; key = date.getFullYear().toString(); }
    labels.add(key); data[entry.type][key] = (data[entry.type][key] || 0) + entry.amount;
  });
  const sortedLabels = Array.from(labels).sort();
  const style = getComputedStyle(document.documentElement);
  const chartData = {
    labels: sortedLabels,
    datasets: [ { label: 'Assets', data: sortedLabels.map(l => data.asset[l] || 0), backgroundColor: style.getPropertyValue('--success') }, { label: 'Liabilities', data: sortedLabels.map(l => data.liability[l] || 0), backgroundColor: style.getPropertyValue('--danger') } ]
  };
  const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: style.getPropertyValue('--text-secondary') } }, x: { ticks: { color: style.getPropertyValue('--text-secondary') } } }, plugins: { legend: { labels: { color: style.getPropertyValue('--text-secondary') } } } };
  const canvas = document.getElementById('distribution-chart');
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  chartInstance = new Chart(ctx, { type: 'bar', data: chartData, options: chartOptions });
}
async function downloadChartImage() {
  if (!chartInstance) { showToast('No chart to download.', 'error'); return; }
  try {
      const canvas = document.getElementById('distribution-chart'), period = localStorage.getItem('chartPeriod') || 'monthly';
      const entries = await getEntries({ types: ['asset', 'liability'] });
      const totalAssets=entries.filter(e=>e.type==='asset').reduce((s,e)=>s+(e.amount||0),0), totalLiabilities=entries.filter(e=>e.type==='liability').reduce((s,e)=>s+(e.amount||0),0), netPosition=totalAssets-totalLiabilities;
      const scale=2, width=1200, height=800; const exportCanvas=document.createElement('canvas'); exportCanvas.width=width*scale; exportCanvas.height=height*scale;
      const ctx = exportCanvas.getContext('2d'); ctx.scale(scale, scale);
      const style = getComputedStyle(document.documentElement); const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      ctx.fillStyle = isDark ? style.getPropertyValue('--bg').trim() : '#ffffff'; ctx.fillRect(0,0,width,height);
      ctx.fillStyle = isDark ? style.getPropertyValue('--text').trim() : '#1f2937'; ctx.font = 'bold 28px sans-serif'; ctx.fillText('Alert Jar - Financial Distribution', 40, 50);
      ctx.font = '16px sans-serif'; ctx.fillStyle = isDark ? style.getPropertyValue('--text-secondary').trim() : '#6b7280'; ctx.fillText(`${period.charAt(0).toUpperCase() + period.slice(1)} View ‚Ä¢ ${new Date().toLocaleDateString(navigator.language || 'en-IN')}`, 40, 75);
      const boxY=100, boxHeight=80, boxWidth=(width-120)/3;
      const drawBox = (x, bg, color, val, label) => { ctx.fillStyle=bg;ctx.fillRect(x,boxY,boxWidth,boxHeight);ctx.fillStyle=color;ctx.font='bold 24px sans-serif';ctx.fillText(formatCurrency(val),x+20,boxY+35);ctx.font='14px sans-serif';ctx.fillText(label,x+20,boxY+60); };
      drawBox(40, isDark?'#064e3b':'#ecfdf5', isDark?'#6ee7b7':'#059669', totalAssets, 'Total Assets');
      drawBox(40 + boxWidth + 20, isDark?'#7f1d1d':'#fef2f2', isDark?'#fca5a5':'#dc2626', totalLiabilities, 'Total Liabilities');
      drawBox(40 + 2 * (boxWidth + 20), netPosition >= 0 ? (isDark?'#064e3b':'#ecfdf5') : (isDark?'#7f1d1d':'#fef2f2'), netPosition >= 0 ? (isDark?'#6ee7b7':'#059669') : (isDark?'#fca5a5':'#dc2626'), netPosition, 'Net Position');
      ctx.drawImage(canvas, 40, boxY + boxHeight + 30, width - 80, height - (boxY + boxHeight + 30) - 80);
      ctx.fillStyle = isDark ? style.getPropertyValue('--text-secondary').trim() : '#9ca3af'; ctx.font = '14px sans-serif'; ctx.fillText('Generated by dear&co (dear.is-a.dev)', 40, height - 40);
      exportCanvas.toBlob((blob) => {
        if (!blob) { showToast('Failed to generate image', 'error'); return; }
        downloadBlob(blob, `alertjar-${period}-${getLocalDate()}.png`);
      }, 'image/png', 1.0);
  } catch (error) {
    console.error('Chart export failed:', error);
    showToast('Failed to download chart.', 'error');
  }
}
const formatCsvField = (data) => {
    if (typeof data === 'number') return data.toString().replace('.', ',');
    const string = String(data ?? '');
    return (/[",\n]/.test(string)) ? `"${string.replace(/"/g, '""')}"` : string;
};
async function exportData(format) {
  const entries = await getRawEntries();
  if(entries.length === 0) { showToast('No data to export.', 'info'); return; }
  const date = getLocalDate();
  const metadata = { exportDate: new Date().toISOString(), appName: 'Alert Jar', appVersion: APP_VERSION, exportedBy: 'dear&co', website: 'https://dear.is-a.dev', totalEntries: entries.length };
  if (format === 'json') {
    downloadBlob(new Blob([JSON.stringify({ metadata, entries }, null, 2)], { type: 'application/json' }), `alertjar-export-${date}.json`);
  } else if (format === 'csv') {
    const assetTotal=entries.filter(e=>e.type==='asset').reduce((s,e)=>s+(e.amount||0),0), liabilityTotal=entries.filter(e=>e.type==='liability').reduce((s,e)=>s+(e.amount||0),0);
    const lines = [`# Alert Jar Export - by dear&co`, `# Generated: ${new Date().toLocaleString()}`, `# Total Entries: ${entries.length}`, `# Net Position: ${formatCurrency(assetTotal - liabilityTotal)}`, '', ['ID','Type','Timestamp (ISO)','Text','Amount','Tags','Source','Todo Status','Todo Due'].join(',')];
    [...entries].sort((a, b) => b.timestamp - a.timestamp).forEach(e => lines.push([e.id,e.type,new Date(e.timestamp).toISOString(),e.text,e.amount??'',e.tags?.join(';'),e.source,e.todoMeta?.status,e.todoMeta?.due].map(formatCsvField).join(',')));
    downloadBlob(new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' }), `alertjar-export-${date}.csv`);
  }
  showToast(`Exported ${entries.length} entries as ${format.toUpperCase()}`, 'success');
}
function downloadBlob(blob, filename) { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href); }
const validateImportedData = (entries) => {
    if (!Array.isArray(entries)) return false;
    return entries.every(e => {
        if (!['id', 'type', 'date', 'timestamp', 'text'].every(f => f in e)) return false;
        if (typeof e.id !== 'string' || !/^[0-9a-f-]{36}$/i.test(e.id)) return false;
        if (!['asset', 'liability', 'diary', 'todo'].includes(e.type)) return false;
        if (!/^\d{4}-\d{2}-\d{2}$/.test(e.date)) return false;
        if (typeof e.timestamp !== 'number' || e.timestamp < 0) return false;
        if (typeof e.text !== 'string') return false;
        if ('amount' in e && typeof e.amount !== 'number' && e.amount !== null) return false;
        if ('tags' in e && !Array.isArray(e.tags)) return false;
        if ('source' in e && typeof e.source !== 'string') return false;
        return true;
    });
};
document.getElementById('import-json').onchange = (e) => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = async (event) => {
    try {
      const data = JSON.parse(event.target.result);
      const entries = data.entries ?? (Array.isArray(data) ? data : null);
      if (!validateImportedData(entries)) throw new Error("Invalid format");
      if(!confirm(`Import ${entries.length} entries? This will overwrite existing data.`)) return;
      await dbRequest('entries', 'readwrite', 'clear');
      const tx = db.transaction(['entries'], 'readwrite');
      entries.forEach(entry => tx.objectStore('entries').put(entry));
      tx.oncomplete = () => { showToast(`Imported ${entries.length} entries`, 'success'); refreshAll(); };
      tx.onerror = () => showToast('Import failed.', 'error');
    } catch (error) { showToast('Invalid or corrupt JSON file.', 'error'); console.error(error); }
  };
  reader.readAsText(file); e.target.value = '';
};

// --- Theme & Modal Management ---
const applyTheme = (theme) => {
  document.documentElement.setAttribute('data-theme', theme);
  try { localStorage.setItem('theme', theme); } catch(e) { console.warn('Could not save theme to localStorage.'); }
  if(document.getElementById('graphs-tab').classList.contains('active') && chartInstance) renderDistributionGraph();
};
const toggleTheme = () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
let lastFocusedElement;
const modalFocusHandlers = new WeakMap();
function openModal(modalId, setupFn) {
  const modal = document.getElementById(modalId);
  lastFocusedElement = document.activeElement; if(setupFn) setupFn(modal);
  modal.classList.add('active'); modal.querySelector('button, a, input')?.focus();
  const oldHandler = modalFocusHandlers.get(modal);
  if (oldHandler) modal.removeEventListener('keydown', oldHandler);
  const handler = (e) => trapFocus(e, modal);
  modalFocusHandlers.set(modal, handler);
  modal.addEventListener('keydown', handler);
}
function closeModal(modal) {
  modal.classList.remove('active');
  const handler = modalFocusHandlers.get(modal);
  if (handler) { modal.removeEventListener('keydown', handler); modalFocusHandlers.delete(modal); }
  if(lastFocusedElement) lastFocusedElement.focus();
}
function trapFocus(e, modal) {
  if (e.key === 'Escape') { closeModal(modal); return; }
  if (e.key === 'Tab') {
    const focusable = Array.from(modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(el => el.offsetParent !== null);
    if(focusable.length === 0) return;
    const first = focusable[0], last = focusable[focusable.length - 1];
    if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
    else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
  }
}

// --- Init & Event Listeners ---
const debounce = (id, func, wait) => { clearTimeout(DEBOUNCE_TIMERS[id]); DEBOUNCE_TIMERS[id] = setTimeout(func, wait); };
const refreshAll = async () => {
    if (refreshPromise) return refreshPromise;
    refreshPromise = (async () => {
        try {
            await Promise.allSettled([
                getEntries({type:'asset'}).then(entries => renderEntries('asset', entries)),
                getEntries({type:'liability'}).then(entries => renderEntries('liability', entries)),
                refreshDiary(),
                refreshTodos(),
                renderCalendar(),
                updateProfileStats()
            ]);
            if (document.getElementById('graphs-tab').classList.contains('active')) await renderDistributionGraph();
        } finally { refreshPromise = null; }
    })();
    return refreshPromise;
};
document.addEventListener('click', (e) => {
  const target = e.target;
  const recordBtn = target.closest('.record-btn');
  if (recordBtn) {
    handleRecordButtonClick(recordBtn.dataset.type);
    return;
  }
  const actionTarget = target.closest('[data-action]');
  const tabBtn = target.closest('.tab-btn');
  if (tabBtn) {
    document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
    tabBtn.classList.add('active'); document.getElementById(`${tabBtn.dataset.tab}-tab`).classList.add('active');
    if (recognitionIsActive) stopRecording(); Object.keys(DEBOUNCE_TIMERS).forEach(key => clearTimeout(DEBOUNCE_TIMERS[key]));
    document.querySelectorAll('.tag.active').forEach(t => t.classList.remove('active')); activeDiaryTag = null;
    if (tabBtn.dataset.tab === 'diary') document.getElementById('search-diary').value = '';
    if (tabBtn.dataset.tab === 'graphs') renderDistributionGraph();
    return;
  }
  const subTabBtn = target.closest('.sub-tab-btn');
  if (subTabBtn) {
    const parent = subTabBtn.closest('.sub-tab-nav').dataset.parent;
    document.querySelectorAll(`#${parent}-tab .sub-tab-btn, #${parent}-tab .sub-tab-content`).forEach(el => el.classList.remove('active'));
    subTabBtn.classList.add('active'); document.getElementById(`${subTabBtn.dataset.tab}-subtab`).classList.add('active');
    return;
  }
  const periodBtn = target.closest('.graph-period-selector .btn');
  if (periodBtn) { try{localStorage.setItem('chartPeriod', periodBtn.dataset.period);}catch(e){} document.querySelectorAll('.graph-period-selector .btn').forEach(b => b.classList.remove('active')); periodBtn.classList.add('active'); renderDistributionGraph(); return; }
  const calendarDay = target.closest('.calendar-day[role="button"]');
  if (calendarDay) { showDayEntries(calendarDay.dataset.date); return; }
  if (actionTarget) {
    const action = actionTarget.dataset.action;
    if(action === 'add') addEntry(actionTarget.dataset.type, document.getElementById(`manual-${actionTarget.dataset.type}`).value, actionTarget);
    else if(action === 'add-diary') addDiaryEntry(document.getElementById('manual-diary').value, actionTarget);
    else if(action === 'add-todo') addTodo();
    const entryEl = actionTarget.closest('[data-id]');
    if (entryEl) {
      if(action === 'delete' && confirm('Are you sure you want to delete this entry?')) deleteEntry(entryEl.dataset.id).then(() => { showToast('Entry deleted', 'success'); refreshAll(); }).catch(() => showToast('Failed to delete', 'error'));
      else if(action === 'toggle-todo') toggleTodo(entryEl.dataset.id);
    }
    return;
  }
  const tagEl = target.closest('.tag[data-tag]');
  if(tagEl) {
    const parentTab = tagEl.closest('.tab-content');
    if (parentTab.id === 'diary-tab') filterDiaryByTag(tagEl.dataset.tag, tagEl);
    else filterByTag(tagEl.closest('.sub-tab-content').id.includes('asset') ? 'asset' : 'liability', tagEl.dataset.tag, tagEl);
  }
});
document.getElementById('search-diary').addEventListener('input', () => debounce('diarySearch', refreshDiary, 300));
['manual-asset', 'manual-liability', 'manual-diary'].forEach(id => document.getElementById(id).addEventListener('focus', () => { isVoice = false; }));
document.getElementById('download-chart').addEventListener('click', downloadChartImage);
document.getElementById('help-btn').addEventListener('click', () => openModal('help-modal'));
document.getElementById('clear-data-btn').addEventListener('click', async () => { if(confirm('This will permanently delete all data. Are you sure?')) { await dbRequest('entries','readwrite','clear'); await refreshAll(); showToast('All data cleared.', 'success'); } });
document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
document.querySelectorAll('.modal').forEach(m => { m.addEventListener('click', (e) => { if (e.target === m) closeModal(m); }); m.querySelector('.modal-close').addEventListener('click', () => closeModal(m)); });
document.getElementById('prev-month').addEventListener('click', () => { currentCalendarMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() - 1, 1); renderCalendar(); });
document.getElementById('next-month').addEventListener('click', () => { currentCalendarMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + 1, 1); renderCalendar(); });
document.getElementById('today-btn').addEventListener('click', () => { currentCalendarMonth = new Date(); renderCalendar(); });
document.getElementById('export-json').addEventListener('click', () => exportData('json'));
document.getElementById('export-csv').addEventListener('click', () => exportData('csv'));
document.getElementById('date-format-select').addEventListener('change', (e) => { try { localStorage.setItem('dateFormat', e.target.value); } catch(e) {} refreshAll(); });
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 'h') { e.preventDefault(); openModal('help-modal'); }
  if (e.target.matches('.calendar-day[role="button"]') && (e.key === 'Enter' || e.key === ' ')) { e.preventDefault(); showDayEntries(e.target.dataset.date); }
  if (e.target.matches('input, textarea, [contenteditable]')) return;
  const tabs = [...document.querySelectorAll('.tab-btn')], currentIndex = tabs.findIndex(tab => tab.classList.contains('active'));
  if (e.key === 'ArrowLeft') tabs[(currentIndex - 1 + tabs.length) % tabs.length].click();
  else if (e.key === 'ArrowRight') tabs[(currentIndex + 1) % tabs.length].click();
});
let touchStartX = 0;
document.addEventListener('touchstart', (e) => {
  if (e.target.closest('.entries, .calendar-grid, .chart-container, input, button, select, a')) return;
  touchStartX = e.changedTouches[0].screenX;
}, { passive: true });
document.addEventListener('touchend', (e) => {
  if (touchStartX === 0 || document.querySelector('.modal.active')) return;
  const touchEndX = e.changedTouches[0].screenX, diff = touchStartX - touchEndX;
  if (Math.abs(diff) < 50) return;
  const activeSubNav = document.querySelector('.tab-content.active .sub-tab-nav');
  if (activeSubNav) {
    const subTabs = [...activeSubNav.querySelectorAll('.sub-tab-btn')], currentSubIndex = subTabs.findIndex(t => t.classList.contains('active'));
    if (diff > 0 && currentSubIndex < subTabs.length - 1) subTabs[currentSubIndex + 1].click();
    else if (diff < 0 && currentSubIndex > 0) subTabs[currentSubIndex - 1].click();
  } else {
    const tabs = [...document.querySelectorAll('.tab-btn')], currentIndex = tabs.findIndex(tab => tab.classList.contains('active'));
    if (diff > 0 && currentIndex < tabs.length - 1) tabs[currentIndex + 1].click();
    else if (diff < 0 && currentIndex > 0) tabs[currentIndex - 1].click();
  }
  touchStartX = 0;
});
window.addEventListener('beforeunload', stopRecording);

// --- Google API Integration ---
function disableGoogleFeatures() {
    showToast('Google services are unavailable.', 'error');
    const connectBtn = document.getElementById('google-connect-btn');
    if (connectBtn) {
        connectBtn.disabled = true;
        connectBtn.textContent = 'Google Unavailable';
    }
    ['backup-now-btn', 'restore-data-btn', 'delete-account-btn'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = true;
    });
}
function gapiLoaded() {
    if (typeof gapi === 'undefined' || !gapi.load) {
        console.error('GAPI script failed to load or initialize.');
        return disableGoogleFeatures();
    }
    gapi.load('client', initializeGapiClient);
}
async function initializeGapiClient() {
    try {
        await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: GOOGLE_DISCOVERY_DOCS });
    } catch (error) {
        console.error('GAPI client initialization failed:', error);
        disableGoogleFeatures();
    }
}
function gisLoaded() {
    if (typeof google === 'undefined' || !google.accounts) {
        console.error('GIS script failed to load or initialize.');
        return disableGoogleFeatures();
    }
    try {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_SCOPES,
            callback: handleGoogleAuthResponse,
        });
    } catch (error) {
        console.error('GIS client initialization failed:', error);
        disableGoogleFeatures();
    }
}
function handleGoogleAuthClick() {
    if (!tokenClient) {
        showToast('Google Sign-In is not ready. Please check your connection or ad-blocker.', 'error');
        return;
    }
    tokenClient.requestAccessToken({prompt: 'consent'});
}
async function handleGoogleAuthResponse(res) {
    if (res.error) { return showToast('Google sign-in failed.', 'error'); }
    gapi.client.setToken(res);
    localStorage.setItem('google_auth', JSON.stringify(res));
    const profile = await gapi.client.people.people.get({ resourceName: 'people/me', personFields: 'names,emailAddresses,photos' });
    const user = {
        name: profile.result.names?.[0]?.displayName ?? 'User',
        email: profile.result.emailAddresses?.[0]?.value,
        avatar: profile.result.photos?.[0]?.url,
        joinDate: getLocalDate()
    };
    localStorage.setItem('userProfile', JSON.stringify(user));
    updateUIAfterAuth(user);
    showToast('Connected to Google!', 'success');
}
function updateUIAfterAuth(user) {
    document.getElementById('google-sign-in-prompt').classList.add('hidden');
    const profileCard = document.getElementById('user-profile-card');
    profileCard.classList.remove('hidden');
    document.getElementById('user-avatar').src = user.avatar || '';
    document.getElementById('user-name').textContent = user.name;
    document.getElementById('user-email').textContent = user.email;
    document.getElementById('user-join-date').textContent = new Date(user.joinDate).toLocaleDateString();
    document.getElementById('drive-status').classList.replace('disconnected', 'connected');
    document.getElementById('drive-status').querySelector('span').textContent = 'Connected';
    document.getElementById('google-connect-btn').classList.add('hidden');
    document.getElementById('google-disconnect-btn').classList.remove('hidden');
    ['backup-now-btn', 'restore-data-btn', 'delete-account-btn'].forEach(id => document.getElementById(id).disabled = false);
    updateProfileStats();
}
function handleGoogleDisconnect() {
    const token = gapi.client.getToken();
    if (token) google.accounts.oauth2.revoke(token.access_token, () => {});
    gapi.client.setToken(null);
    localStorage.removeItem('google_auth');
    localStorage.removeItem('userProfile');
    document.getElementById('google-sign-in-prompt').classList.remove('hidden');
    document.getElementById('user-profile-card').classList.add('hidden');
    document.getElementById('drive-status').classList.replace('connected', 'disconnected');
    document.getElementById('drive-status').querySelector('span').textContent = 'Disconnected';
    document.getElementById('google-connect-btn').classList.remove('hidden');
    document.getElementById('google-disconnect-btn').classList.add('hidden');
    ['backup-now-btn', 'restore-data-btn', 'delete-account-btn'].forEach(id => document.getElementById(id).disabled = true);
    showToast('Disconnected from Google.', 'info');
}
async function updateProfileStats() {
    const entries = await getRawEntries();
    document.getElementById('stat-total-entries').textContent = entries.length;
    const netWorth = entries.reduce((acc, e) => {
        if(e.type === 'asset') return acc + (e.amount || 0);
        if(e.type === 'liability') return acc - (e.amount || 0);
        return acc;
    }, 0);
    document.getElementById('stat-net-worth').textContent = formatCurrency(netWorth);
}

// --- Init & Event Listeners ---
async function init() {
  try {
    await initDB();
    document.getElementById('google-connect-btn').addEventListener('click', handleGoogleAuthClick);
    document.getElementById('google-disconnect-btn').addEventListener('click', handleGoogleDisconnect);
    const userProfile = JSON.parse(localStorage.getItem('userProfile'));
    const googleAuth = JSON.parse(localStorage.getItem('google_auth'));
    if (userProfile && googleAuth && typeof gapi !== 'undefined' && gapi.client) {
        gapi.client.setToken(googleAuth);
        updateUIAfterAuth(userProfile);
    }
    await refreshAll();
    await checkMissedTasks();
    setInterval(checkMissedTasks, 60 * 1000);
  } catch (error) {
    console.error('Initialization failed:', error);
    showToast('Failed to initialize application. Please refresh.', 'error');
  }
  try { initSpeechRecognition(); } catch (error) { console.warn('Speech recognition not available:', error); }
  try{
    const savedTheme = localStorage.getItem('theme');
    const themeToApply = savedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(themeToApply);
    document.getElementById('theme-select').value = savedTheme || 'auto';
  } catch(e) { applyTheme('light'); }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
